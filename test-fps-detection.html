<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS 檢測測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
        .metric strong {
            color: #2c3e50;
        }
        .log {
            background: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 FPS 檢測測試</h1>
        <p>這個頁面用來測試 CDN Detector 的 FPS 檢測功能</p>

        <div class="info-box">
            <h3>測試視頻</h3>
            <video id="testVideo" controls>
                <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4">
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                您的瀏覽器不支援視頻播放
            </video>
            
            <div>
                <button id="playBtn">播放視頻</button>
                <button id="pauseBtn">暫停視頻</button>
                <button id="checkBtn">檢查 FPS</button>
                <button id="clearBtn">清除日誌</button>
            </div>
        </div>

        <div class="info-box">
            <h3>📊 視頻指標</h3>
            <div id="metrics">
                <div class="metric">
                    <span>解析度:</span>
                    <strong id="resolution">N/A</strong>
                </div>
                <div class="metric">
                    <span>幀率 (FPS):</span>
                    <strong id="fps">N/A</strong>
                </div>
                <div class="metric">
                    <span>播放狀態:</span>
                    <strong id="playState">N/A</strong>
                </div>
                <div class="metric">
                    <span>總幀數:</span>
                    <strong id="totalFrames">N/A</strong>
                </div>
                <div class="metric">
                    <span>掉幀數:</span>
                    <strong id="droppedFrames">N/A</strong>
                </div>
                <div class="metric">
                    <span>幀率來源:</span>
                    <strong id="fpsSource">N/A</strong>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>📝 檢測日誌</h3>
            <div id="log" class="log">
                等待檢測...
            </div>
        </div>

        <div class="info-box">
            <h3>ℹ️ 說明</h3>
            <ul>
                <li><strong>方法1</strong>: MediaStream API (最準確，適用於攝像頭/直播)</li>
                <li><strong>方法2</strong>: 基於播放品質計算 (需要等待至少1秒)</li>
                <li><strong>方法3</strong>: Firefox 專用屬性</li>
                <li><strong>方法4</strong>: 基於解析度推測 (備用方案)</li>
                <li><strong>方法5</strong>: 預設值 (最後備案)</li>
            </ul>
        </div>
    </div>

    <script>
        const video = document.getElementById('testVideo');
        const logDiv = document.getElementById('log');
        const metricsElements = {
            resolution: document.getElementById('resolution'),
            fps: document.getElementById('fps'),
            playState: document.getElementById('playState'),
            totalFrames: document.getElementById('totalFrames'),
            droppedFrames: document.getElementById('droppedFrames'),
            fpsSource: document.getElementById('fpsSource')
        };

        let logMessages = [];
        let lastMetric = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logMessages.push(logMessage);
            
            // 保持最新 50 條日誌
            if (logMessages.length > 50) {
                logMessages = logMessages.slice(-50);
            }
            
            logDiv.textContent = logMessages.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logMessages = [];
            logDiv.textContent = '日誌已清除...';
        }

        function playVideo() {
            video.play();
            log('開始播放視頻');
        }

        function pauseVideo() {
            video.pause();
            log('暫停視頻');
        }

        function updateMetrics() {
            // 基本信息
            if (video.videoWidth && video.videoHeight) {
                metricsElements.resolution.textContent = `${video.videoWidth}x${video.videoHeight}`;
            }

            metricsElements.playState.textContent = video.paused ? '暫停' : '播放中';

            // 播放品質信息
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                metricsElements.totalFrames.textContent = quality.totalVideoFrames || 0;
                metricsElements.droppedFrames.textContent = quality.droppedVideoFrames || 0;
            }
        }

        function detectFPS() {
            let detectedFPS = null;
            let source = 'N/A';

            // 方法1: MediaStream API
            if (video.srcObject && video.srcObject.getVideoTracks) {
                try {
                    const tracks = video.srcObject.getVideoTracks();
                    if (tracks.length > 0) {
                        const settings = tracks[0].getSettings();
                        if (settings.frameRate) {
                            detectedFPS = Math.round(settings.frameRate);
                            source = 'MediaStream API';
                            log(`方法1成功: MediaStream API - ${detectedFPS} fps`);
                        }
                    }
                } catch (e) {
                    log(`方法1失敗: MediaStream API - ${e.message}`);
                }
            }

            // 方法2: 基於播放品質計算
            if (!detectedFPS && video.getVideoPlaybackQuality) {
                const currentTime = Date.now();
                const quality = video.getVideoPlaybackQuality();
                
                if (lastMetric) {
                    const timeDiff = (currentTime - lastMetric.timestamp) / 1000;
                    const frameDiff = quality.totalVideoFrames - lastMetric.totalFrames;
                    
                    log(`方法2計算: 時間差=${timeDiff.toFixed(2)}s, 幀差=${frameDiff}`);
                    
                    if (timeDiff >= 1.0 && frameDiff > 0) {
                        const calculatedFPS = Math.round(frameDiff / timeDiff);
                        if (calculatedFPS >= 5 && calculatedFPS <= 120) {
                            detectedFPS = calculatedFPS;
                            source = 'Calculated';
                            log(`方法2成功: 計算得出 - ${detectedFPS} fps`);
                        } else {
                            log(`方法2失敗: 計算的幀率不合理 - ${calculatedFPS} fps`);
                        }
                    }
                }
                
                lastMetric = {
                    timestamp: currentTime,
                    totalFrames: quality.totalVideoFrames
                };
            }

            // 方法3: Firefox 專用
            if (!detectedFPS && video.mozPaintedFrames !== undefined && video.mozFrameDelay !== undefined) {
                const fps = Math.round(1000 / video.mozFrameDelay);
                if (fps >= 5 && fps <= 120) {
                    detectedFPS = fps;
                    source = 'Firefox mozFrameDelay';
                    log(`方法3成功: Firefox - ${detectedFPS} fps`);
                }
            }

            // 方法4: 基於解析度推測
            if (!detectedFPS && video.videoHeight && video.videoWidth) {
                const height = video.videoHeight;
                log(`方法4: 基於解析度推測 - ${video.videoWidth}x${height}`);
                
                if (height >= 1080) {
                    detectedFPS = 60;
                } else if (height >= 720) {
                    detectedFPS = 30;
                } else if (height >= 480) {
                    detectedFPS = 25;
                } else {
                    detectedFPS = 24;
                }
                source = 'Estimated by resolution';
                log(`方法4成功: 解析度推測 - ${detectedFPS} fps`);
            }

            // 方法5: 預設值
            if (!detectedFPS) {
                detectedFPS = 30;
                source = 'Default fallback';
                log(`方法5: 使用預設值 - ${detectedFPS} fps`);
            }

            // 更新顯示
            metricsElements.fps.textContent = `${detectedFPS} fps`;
            metricsElements.fpsSource.textContent = source;

            return detectedFPS;
        }

        function checkFPS() {
            log('=== 開始 FPS 檢測 ===');
            updateMetrics();
            detectFPS();
            log('=== FPS 檢測完成 ===');
        }

        // 定期更新
        setInterval(() => {
            updateMetrics();
            if (!video.paused) {
                detectFPS();
            }
        }, 2000);

        // 視頻事件監聽
        video.addEventListener('loadedmetadata', () => {
            log('視頻 metadata 載入完成');
            updateMetrics();
        });

        video.addEventListener('play', () => {
            log('視頻開始播放');
            setTimeout(checkFPS, 1000); // 1秒後檢測FPS
        });

        video.addEventListener('pause', () => {
            log('視頻暫停');
        });

        // 添加按鈕事件監聽器
        document.getElementById('playBtn').addEventListener('click', playVideo);
        document.getElementById('pauseBtn').addEventListener('click', pauseVideo);
        document.getElementById('checkBtn').addEventListener('click', checkFPS);
        document.getElementById('clearBtn').addEventListener('click', clearLog);

        log('FPS 檢測測試頁面已載入');
    </script>
</body>
</html> 