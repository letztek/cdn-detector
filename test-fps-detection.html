<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS æª¢æ¸¬æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
        .metric strong {
            color: #2c3e50;
        }
        .log {
            background: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ FPS æª¢æ¸¬æ¸¬è©¦</h1>
        <p>é€™å€‹é é¢ç”¨ä¾†æ¸¬è©¦ CDN Detector çš„ FPS æª¢æ¸¬åŠŸèƒ½</p>

        <div class="info-box">
            <h3>æ¸¬è©¦è¦–é »</h3>
            <video id="testVideo" controls>
                <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4">
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾
            </video>
            
            <div>
                <button id="playBtn">æ’­æ”¾è¦–é »</button>
                <button id="pauseBtn">æš«åœè¦–é »</button>
                <button id="checkBtn">æª¢æŸ¥ FPS</button>
                <button id="clearBtn">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>

        <div class="info-box">
            <h3>ğŸ“Š è¦–é »æŒ‡æ¨™</h3>
            <div id="metrics">
                <div class="metric">
                    <span>è§£æåº¦:</span>
                    <strong id="resolution">N/A</strong>
                </div>
                <div class="metric">
                    <span>å¹€ç‡ (FPS):</span>
                    <strong id="fps">N/A</strong>
                </div>
                <div class="metric">
                    <span>æ’­æ”¾ç‹€æ…‹:</span>
                    <strong id="playState">N/A</strong>
                </div>
                <div class="metric">
                    <span>ç¸½å¹€æ•¸:</span>
                    <strong id="totalFrames">N/A</strong>
                </div>
                <div class="metric">
                    <span>æ‰å¹€æ•¸:</span>
                    <strong id="droppedFrames">N/A</strong>
                </div>
                <div class="metric">
                    <span>å¹€ç‡ä¾†æº:</span>
                    <strong id="fpsSource">N/A</strong>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>ğŸ“ æª¢æ¸¬æ—¥èªŒ</h3>
            <div id="log" class="log">
                ç­‰å¾…æª¢æ¸¬...
            </div>
        </div>

        <div class="info-box">
            <h3>â„¹ï¸ èªªæ˜</h3>
            <ul>
                <li><strong>æ–¹æ³•1</strong>: MediaStream API (æœ€æº–ç¢ºï¼Œé©ç”¨æ–¼æ”åƒé ­/ç›´æ’­)</li>
                <li><strong>æ–¹æ³•2</strong>: åŸºæ–¼æ’­æ”¾å“è³ªè¨ˆç®— (éœ€è¦ç­‰å¾…è‡³å°‘1ç§’)</li>
                <li><strong>æ–¹æ³•3</strong>: Firefox å°ˆç”¨å±¬æ€§</li>
                <li><strong>æ–¹æ³•4</strong>: åŸºæ–¼è§£æåº¦æ¨æ¸¬ (å‚™ç”¨æ–¹æ¡ˆ)</li>
                <li><strong>æ–¹æ³•5</strong>: é è¨­å€¼ (æœ€å¾Œå‚™æ¡ˆ)</li>
            </ul>
        </div>
    </div>

    <script>
        const video = document.getElementById('testVideo');
        const logDiv = document.getElementById('log');
        const metricsElements = {
            resolution: document.getElementById('resolution'),
            fps: document.getElementById('fps'),
            playState: document.getElementById('playState'),
            totalFrames: document.getElementById('totalFrames'),
            droppedFrames: document.getElementById('droppedFrames'),
            fpsSource: document.getElementById('fpsSource')
        };

        let logMessages = [];
        let lastMetric = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logMessages.push(logMessage);
            
            // ä¿æŒæœ€æ–° 50 æ¢æ—¥èªŒ
            if (logMessages.length > 50) {
                logMessages = logMessages.slice(-50);
            }
            
            logDiv.textContent = logMessages.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logMessages = [];
            logDiv.textContent = 'æ—¥èªŒå·²æ¸…é™¤...';
        }

        function playVideo() {
            video.play();
            log('é–‹å§‹æ’­æ”¾è¦–é »');
        }

        function pauseVideo() {
            video.pause();
            log('æš«åœè¦–é »');
        }

        function updateMetrics() {
            // åŸºæœ¬ä¿¡æ¯
            if (video.videoWidth && video.videoHeight) {
                metricsElements.resolution.textContent = `${video.videoWidth}x${video.videoHeight}`;
            }

            metricsElements.playState.textContent = video.paused ? 'æš«åœ' : 'æ’­æ”¾ä¸­';

            // æ’­æ”¾å“è³ªä¿¡æ¯
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                metricsElements.totalFrames.textContent = quality.totalVideoFrames || 0;
                metricsElements.droppedFrames.textContent = quality.droppedVideoFrames || 0;
            }
        }

        function detectFPS() {
            let detectedFPS = null;
            let source = 'N/A';

            // æ–¹æ³•1: MediaStream API
            if (video.srcObject && video.srcObject.getVideoTracks) {
                try {
                    const tracks = video.srcObject.getVideoTracks();
                    if (tracks.length > 0) {
                        const settings = tracks[0].getSettings();
                        if (settings.frameRate) {
                            detectedFPS = Math.round(settings.frameRate);
                            source = 'MediaStream API';
                            log(`æ–¹æ³•1æˆåŠŸ: MediaStream API - ${detectedFPS} fps`);
                        }
                    }
                } catch (e) {
                    log(`æ–¹æ³•1å¤±æ•—: MediaStream API - ${e.message}`);
                }
            }

            // æ–¹æ³•2: åŸºæ–¼æ’­æ”¾å“è³ªè¨ˆç®—
            if (!detectedFPS && video.getVideoPlaybackQuality) {
                const currentTime = Date.now();
                const quality = video.getVideoPlaybackQuality();
                
                if (lastMetric) {
                    const timeDiff = (currentTime - lastMetric.timestamp) / 1000;
                    const frameDiff = quality.totalVideoFrames - lastMetric.totalFrames;
                    
                    log(`æ–¹æ³•2è¨ˆç®—: æ™‚é–“å·®=${timeDiff.toFixed(2)}s, å¹€å·®=${frameDiff}`);
                    
                    if (timeDiff >= 1.0 && frameDiff > 0) {
                        const calculatedFPS = Math.round(frameDiff / timeDiff);
                        if (calculatedFPS >= 5 && calculatedFPS <= 120) {
                            detectedFPS = calculatedFPS;
                            source = 'Calculated';
                            log(`æ–¹æ³•2æˆåŠŸ: è¨ˆç®—å¾—å‡º - ${detectedFPS} fps`);
                        } else {
                            log(`æ–¹æ³•2å¤±æ•—: è¨ˆç®—çš„å¹€ç‡ä¸åˆç† - ${calculatedFPS} fps`);
                        }
                    }
                }
                
                lastMetric = {
                    timestamp: currentTime,
                    totalFrames: quality.totalVideoFrames
                };
            }

            // æ–¹æ³•3: Firefox å°ˆç”¨
            if (!detectedFPS && video.mozPaintedFrames !== undefined && video.mozFrameDelay !== undefined) {
                const fps = Math.round(1000 / video.mozFrameDelay);
                if (fps >= 5 && fps <= 120) {
                    detectedFPS = fps;
                    source = 'Firefox mozFrameDelay';
                    log(`æ–¹æ³•3æˆåŠŸ: Firefox - ${detectedFPS} fps`);
                }
            }

            // æ–¹æ³•4: åŸºæ–¼è§£æåº¦æ¨æ¸¬
            if (!detectedFPS && video.videoHeight && video.videoWidth) {
                const height = video.videoHeight;
                log(`æ–¹æ³•4: åŸºæ–¼è§£æåº¦æ¨æ¸¬ - ${video.videoWidth}x${height}`);
                
                if (height >= 1080) {
                    detectedFPS = 60;
                } else if (height >= 720) {
                    detectedFPS = 30;
                } else if (height >= 480) {
                    detectedFPS = 25;
                } else {
                    detectedFPS = 24;
                }
                source = 'Estimated by resolution';
                log(`æ–¹æ³•4æˆåŠŸ: è§£æåº¦æ¨æ¸¬ - ${detectedFPS} fps`);
            }

            // æ–¹æ³•5: é è¨­å€¼
            if (!detectedFPS) {
                detectedFPS = 30;
                source = 'Default fallback';
                log(`æ–¹æ³•5: ä½¿ç”¨é è¨­å€¼ - ${detectedFPS} fps`);
            }

            // æ›´æ–°é¡¯ç¤º
            metricsElements.fps.textContent = `${detectedFPS} fps`;
            metricsElements.fpsSource.textContent = source;

            return detectedFPS;
        }

        function checkFPS() {
            log('=== é–‹å§‹ FPS æª¢æ¸¬ ===');
            updateMetrics();
            detectFPS();
            log('=== FPS æª¢æ¸¬å®Œæˆ ===');
        }

        // å®šæœŸæ›´æ–°
        setInterval(() => {
            updateMetrics();
            if (!video.paused) {
                detectFPS();
            }
        }, 2000);

        // è¦–é »äº‹ä»¶ç›£è½
        video.addEventListener('loadedmetadata', () => {
            log('è¦–é » metadata è¼‰å…¥å®Œæˆ');
            updateMetrics();
        });

        video.addEventListener('play', () => {
            log('è¦–é »é–‹å§‹æ’­æ”¾');
            setTimeout(checkFPS, 1000); // 1ç§’å¾Œæª¢æ¸¬FPS
        });

        video.addEventListener('pause', () => {
            log('è¦–é »æš«åœ');
        });

        // æ·»åŠ æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        document.getElementById('playBtn').addEventListener('click', playVideo);
        document.getElementById('pauseBtn').addEventListener('click', pauseVideo);
        document.getElementById('checkBtn').addEventListener('click', checkFPS);
        document.getElementById('clearBtn').addEventListener('click', clearLog);

        log('FPS æª¢æ¸¬æ¸¬è©¦é é¢å·²è¼‰å…¥');
    </script>
</body>
</html> 