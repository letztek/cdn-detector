<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>edu.tw å®‰å…¨æ¨™é ­æª¢æ¸¬æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .step-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        #testResults {
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ edu.tw å®‰å…¨æ¨™é ­æª¢æ¸¬æ¸¬è©¦</h1>
        <p>å°ˆé–€æ¸¬è©¦ www.edu.tw çš„å®‰å…¨æ¨™é ­æª¢æ¸¬åŠŸèƒ½</p>
        
        <div class="test-step">
            <div class="step-title">Step 1: æ¸¬è©¦ www.edu.tw</div>
            <button class="test-button" id="testEduTw">ğŸŒ æ¸¬è©¦ www.edu.tw</button>
            <button class="test-button" id="testEduTwManual">ğŸ”§ æ‰‹å‹•æª¢æ¸¬ www.edu.tw</button>
        </div>
        
        <div class="test-step">
            <div class="step-title">Step 2: é©—è­‰ç³»çµ±ç‹€æ…‹</div>
            <button class="test-button" id="checkSystemStatus">âš™ï¸ æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
            <button class="test-button" id="checkSecurityManager">ğŸ›¡ï¸ æª¢æŸ¥å®‰å…¨ç®¡ç†å™¨</button>
        </div>
        
        <div class="test-step">
            <div class="step-title">Step 3: æª¢æŸ¥å­˜å„²è³‡æ–™</div>
            <button class="test-button" id="checkStorageData">ğŸ’¾ æª¢æŸ¥å­˜å„²è³‡æ–™</button>
            <button class="test-button" id="checkDebugLogs">ğŸ“ æª¢æŸ¥èª¿è©¦æ—¥èªŒ</button>
        </div>
        
        <div class="test-step">
            <div class="step-title">Step 4: æ¨¡æ“¬æ¸¬è©¦</div>
            <button class="test-button" id="simulateEduTw">ğŸ§ª æ¨¡æ“¬ edu.tw è«‹æ±‚</button>
            <button class="test-button" id="clearResults">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
        </div>
        
        <div id="testResults"></div>
    </div>

    <script src="test-edu-tw-headers.js"></script>
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `test-result ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            testResults.appendChild(logEntry);
            console.log(`[${timestamp}] ${message}`);
            
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        function formatJSON(obj) {
            return `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
        }
        
        function clearResults() {
            testResults.innerHTML = '';
        }
        
        // Test www.edu.tw
        document.getElementById('testEduTw').addEventListener('click', async () => {
            log('ğŸŒ é–‹å§‹æ¸¬è©¦ www.edu.tw...', 'info');
            
            try {
                // é–‹å•Ÿ edu.tw é é¢
                const tab = await chrome.tabs.create({ 
                    url: 'https://www.edu.tw', 
                    active: false 
                });
                
                eduTwTabId = tab.id;
                log(`âœ… å·²é–‹å•Ÿ edu.tw æ¨™ç±¤é  ${tab.id}`, 'success');
                
                // ç­‰å¾…é é¢è¼‰å…¥
                log('â³ ç­‰å¾…é é¢è¼‰å…¥ (5ç§’)...', 'info');
                await new Promise(resolve => setTimeout(resolve, 5000));
                
                // æª¢æŸ¥æ˜¯å¦æ”¶é›†åˆ°å®‰å…¨è³‡æ–™
                log('ğŸ” æª¢æŸ¥æ˜¯å¦æ”¶é›†åˆ°å®‰å…¨è³‡æ–™...', 'info');
                const response = await chrome.runtime.sendMessage({
                    type: 'GET_SECURITY_DATA',
                    tabId: tab.id
                });
                
                if (response.success && response.data) {
                    log('âœ… æˆåŠŸæª¢æ¸¬åˆ°å®‰å…¨è³‡æ–™ï¼', 'success');
                    log(`å®‰å…¨è³‡æ–™: ${formatJSON(response.data)}`, 'info');
                    
                    // åˆ†æå®‰å…¨è³‡æ–™
                    const data = response.data;
                    if (data.history && data.history.length > 0) {
                        const latest = data.history[data.history.length - 1];
                        log(`ğŸ“Š æœ€æ–°æª¢æ¸¬çµæœ: åˆ†æ•¸ ${latest.score}/100, ç­‰ç´š ${latest.level}`, 'info');
                        
                        if (latest.headers) {
                            let headerCount = 0;
                            if (latest.headers.csp && latest.headers.csp.present) headerCount++;
                            if (latest.headers.frameProtection && latest.headers.frameProtection.present) headerCount++;
                            if (latest.headers.contentType && latest.headers.contentType.present) headerCount++;
                            if (latest.headers.hsts && latest.headers.hsts.present) headerCount++;
                            
                            log(`ğŸ”’ æª¢æ¸¬åˆ° ${headerCount} å€‹å®‰å…¨æ¨™é ­`, 'info');
                        }
                    }
                } else {
                    log('âš ï¸ æœªæª¢æ¸¬åˆ°å®‰å…¨è³‡æ–™', 'warning');
                    log(`éŒ¯èª¤: ${response.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    
                    // å˜—è©¦å†æ¬¡æª¢æ¸¬
                    log('ğŸ”„ å˜—è©¦å†æ¬¡æª¢æ¸¬...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const retryResponse = await chrome.runtime.sendMessage({
                        type: 'GET_SECURITY_DATA',
                        tabId: tab.id
                    });
                    
                    if (retryResponse.success && retryResponse.data) {
                        log('âœ… é‡è©¦æˆåŠŸæª¢æ¸¬åˆ°å®‰å…¨è³‡æ–™ï¼', 'success');
                        log(`å®‰å…¨è³‡æ–™: ${formatJSON(retryResponse.data)}`, 'info');
                    } else {
                        log('âŒ é‡è©¦ä»ç„¶å¤±æ•—', 'error');
                    }
                }
                
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        // Manual test www.edu.tw
        document.getElementById('testEduTwManual').addEventListener('click', async () => {
            log('ğŸ”§ æ‰‹å‹•æª¢æ¸¬ www.edu.tw...', 'info');
            
            try {
                if (!eduTwTabId) {
                    log('âš ï¸ è«‹å…ˆé‹è¡Œ "æ¸¬è©¦ www.edu.tw" ä»¥å‰µå»ºæ¨™ç±¤é ', 'warning');
                    return;
                }
                
                // æ‰‹å‹•è§¸ç™¼å®‰å…¨æª¢æ¸¬
                const response = await chrome.runtime.sendMessage({
                    type: 'MANUAL_SECURITY_CHECK',
                    tabId: eduTwTabId,
                    url: 'https://www.edu.tw'
                });
                
                if (response.success && response.result) {
                    log('âœ… æ‰‹å‹•æª¢æ¸¬æˆåŠŸï¼', 'success');
                    log(`æª¢æ¸¬çµæœ: ${formatJSON(response.result)}`, 'info');
                } else {
                    log('âŒ æ‰‹å‹•æª¢æ¸¬å¤±æ•—', 'error');
                    log(`éŒ¯èª¤: ${response.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ æ‰‹å‹•æª¢æ¸¬éŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // Check system status
        document.getElementById('checkSystemStatus').addEventListener('click', async () => {
            log('âš™ï¸ æª¢æŸ¥ç³»çµ±ç‹€æ…‹...', 'info');
            
            try {
                // æª¢æŸ¥æ“´å±•åŸºæœ¬è³‡è¨Š
                const manifest = chrome.runtime.getManifest();
                log(`æ“´å±•: ${manifest.name} v${manifest.version}`, 'info');
                
                // æª¢æŸ¥æ¬Šé™
                const permissions = manifest.permissions || [];
                log(`æ¬Šé™: ${permissions.join(', ')}`, 'info');
                
                // æª¢æŸ¥ webRequest æ¬Šé™
                if (permissions.includes('webRequest')) {
                    log('âœ… webRequest æ¬Šé™å·²å•Ÿç”¨', 'success');
                } else {
                    log('âŒ webRequest æ¬Šé™ç¼ºå¤±', 'error');
                }
                
                // æª¢æŸ¥ host_permissions
                const hostPermissions = manifest.host_permissions || [];
                log(`ä¸»æ©Ÿæ¬Šé™: ${hostPermissions.join(', ')}`, 'info');
                
                if (hostPermissions.includes('<all_urls>')) {
                    log('âœ… æ‰€æœ‰ URL æ¬Šé™å·²å•Ÿç”¨', 'success');
                } else {
                    log('âŒ ç¼ºå°‘å®Œæ•´ URL æ¬Šé™', 'error');
                }
                
                log('âœ… ç³»çµ±ç‹€æ…‹æª¢æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        // Check SecurityManager
        document.getElementById('checkSecurityManager').addEventListener('click', async () => {
            log('ğŸ›¡ï¸ æª¢æŸ¥å®‰å…¨ç®¡ç†å™¨...', 'info');
            
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_SECURITY_STATUS' });
                
                if (response && response.success) {
                    log('âœ… å®‰å…¨ç®¡ç†å™¨ç‹€æ…‹ç²å–æˆåŠŸ', 'success');
                    log(`ç‹€æ…‹: ${formatJSON(response.status)}`, 'info');
                    
                    const status = response.status;
                    if (status.enabled) {
                        log('âœ… å®‰å…¨ç®¡ç†å™¨å·²å•Ÿç”¨', 'success');
                    } else {
                        log('âŒ å®‰å…¨ç®¡ç†å™¨æœªå•Ÿç”¨', 'error');
                    }
                    
                    if (status.degraded) {
                        log('âš ï¸ å®‰å…¨ç®¡ç†å™¨è™•æ–¼é™ç´šæ¨¡å¼', 'warning');
                    }
                    
                    if (status.moduleLoaded) {
                        log('âœ… å®‰å…¨æ¨¡çµ„å·²è¼‰å…¥', 'success');
                    } else {
                        log('âŒ å®‰å…¨æ¨¡çµ„æœªè¼‰å…¥', 'error');
                    }
                    
                    // æª¢æŸ¥çµ±è¨ˆè³‡æ–™
                    if (status.stats) {
                        log(`ğŸ“Š çµ±è¨ˆ: ç¸½è«‹æ±‚ ${status.stats.totalRequests}, æˆåŠŸ ${status.stats.successfulChecks}, éŒ¯èª¤ ${status.stats.errors}`, 'info');
                    }
                    
                } else {
                    log('âŒ ç„¡æ³•ç²å–å®‰å…¨ç®¡ç†å™¨ç‹€æ…‹', 'error');
                    log(`éŒ¯èª¤: ${response?.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ å®‰å…¨ç®¡ç†å™¨æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        // Check storage data
        document.getElementById('checkStorageData').addEventListener('click', async () => {
            log('ğŸ’¾ æª¢æŸ¥å­˜å„²è³‡æ–™...', 'info');
            
            try {
                const result = await chrome.storage.local.get(null);
                
                // éæ¿¾å®‰å…¨ç›¸é—œè³‡æ–™
                const securityData = {};
                Object.keys(result).forEach(key => {
                    if (key.startsWith('security_')) {
                        securityData[key] = result[key];
                    }
                });
                
                log('âœ… å­˜å„²è³‡æ–™æª¢æŸ¥å®Œæˆ', 'success');
                log(`å®‰å…¨å­˜å„²æ¢ç›®: ${Object.keys(securityData).length}`, 'info');
                
                if (Object.keys(securityData).length > 0) {
                    log(`å®‰å…¨è³‡æ–™: ${formatJSON(securityData)}`, 'info');
                    
                    // åˆ†ææ¯å€‹æ¨™ç±¤é çš„è³‡æ–™
                    Object.keys(securityData).forEach(key => {
                        const data = securityData[key];
                        if (data.history && data.history.length > 0) {
                            const latest = data.history[data.history.length - 1];
                            log(`ğŸ“Š æ¨™ç±¤é  ${data.tabId}: åˆ†æ•¸ ${latest.score}/100, URL: ${latest.url}`, 'info');
                        }
                    });
                } else {
                    log('âš ï¸ æœªæ‰¾åˆ°å®‰å…¨å­˜å„²è³‡æ–™', 'warning');
                }
                
            } catch (error) {
                log(`âŒ å­˜å„²è³‡æ–™æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        // Check debug logs
        document.getElementById('checkDebugLogs').addEventListener('click', async () => {
            log('ğŸ“ æª¢æŸ¥èª¿è©¦æ—¥èªŒ...', 'info');
            
            try {
                const result = await chrome.storage.local.get(['debugLogs']);
                const logs = result.debugLogs || [];
                
                log(`âœ… ç²å–åˆ° ${logs.length} æ¢èª¿è©¦æ—¥èªŒ`, 'success');
                
                if (logs.length > 0) {
                    // éæ¿¾å®‰å…¨ç›¸é—œæ—¥èªŒ
                    const securityLogs = logs.filter(log => 
                        log.includes('Security') || 
                        log.includes('security') || 
                        log.includes('edu.tw')
                    );
                    
                    log(`ğŸ” æ‰¾åˆ° ${securityLogs.length} æ¢å®‰å…¨ç›¸é—œæ—¥èªŒ`, 'info');
                    
                    if (securityLogs.length > 0) {
                        const recentSecurityLogs = securityLogs.slice(-10);
                        log(`æœ€è¿‘å®‰å…¨æ—¥èªŒ: ${formatJSON(recentSecurityLogs)}`, 'info');
                    }
                    
                    // é¡¯ç¤ºæœ€è¿‘çš„æ—¥èªŒ
                    const recentLogs = logs.slice(-5);
                    log(`æœ€è¿‘æ—¥èªŒ: ${formatJSON(recentLogs)}`, 'info');
                    
                } else {
                    log('âš ï¸ æœªæ‰¾åˆ°èª¿è©¦æ—¥èªŒ', 'warning');
                }
                
            } catch (error) {
                log(`âŒ èª¿è©¦æ—¥èªŒæª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        });
        
        // Simulate edu.tw request
        document.getElementById('simulateEduTw').addEventListener('click', async () => {
            log('ğŸ§ª æ¨¡æ“¬ edu.tw è«‹æ±‚...', 'info');
            
            try {
                // æ¨¡æ“¬ edu.tw çš„éŸ¿æ‡‰æ¨™é ­
                const simulatedDetails = {
                    url: 'https://www.edu.tw',
                    type: 'main_frame',
                    tabId: 9999, // æ¨¡æ“¬æ¨™ç±¤é  ID
                    responseHeaders: [
                        { name: 'Content-Security-Policy', value: 'default-src \'self\'; script-src \'self\' \'unsafe-inline\'; style-src \'self\' \'unsafe-inline\';' },
                        { name: 'X-Frame-Options', value: 'SAMEORIGIN' },
                        { name: 'X-Content-Type-Options', value: 'nosniff' },
                        { name: 'X-XSS-Protection', value: '1; mode=block' },
                        { name: 'Server', value: 'Apache/2.4.41 (Ubuntu)' },
                        { name: 'Content-Type', value: 'text/html; charset=UTF-8' }
                    ]
                };
                
                log('ğŸ“¡ ç™¼é€æ¨¡æ“¬è«‹æ±‚...', 'info');
                log(`æ¨¡æ“¬è³‡æ–™: ${formatJSON(simulatedDetails)}`, 'info');
                
                const response = await chrome.runtime.sendMessage({
                    type: 'SIMULATE_SECURITY_REQUEST',
                    details: simulatedDetails
                });
                
                if (response.success && response.result) {
                    log('âœ… æ¨¡æ“¬è«‹æ±‚æˆåŠŸï¼', 'success');
                    log(`æ¨¡æ“¬çµæœ: ${formatJSON(response.result)}`, 'info');
                    
                    const result = response.result;
                    if (result) {
                        log(`ğŸ“Š æ¨¡æ“¬æª¢æ¸¬: åˆ†æ•¸ ${result.score}/100, ç­‰ç´š ${result.level}`, 'info');
                        
                        if (result.headers) {
                            let headerCount = 0;
                            if (result.headers.csp && result.headers.csp.present) headerCount++;
                            if (result.headers.frameProtection && result.headers.frameProtection.present) headerCount++;
                            if (result.headers.contentType && result.headers.contentType.present) headerCount++;
                            
                            log(`ğŸ”’ æ¨¡æ“¬æª¢æ¸¬åˆ° ${headerCount} å€‹å®‰å…¨æ¨™é ­`, 'info');
                        }
                    }
                } else {
                    log('âŒ æ¨¡æ“¬è«‹æ±‚å¤±æ•—', 'error');
                    log(`éŒ¯èª¤: ${response.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ æ¨¡æ“¬è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // Clear results
        document.getElementById('clearResults').addEventListener('click', clearResults);
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ¯ edu.tw å®‰å…¨æ¨™é ­æª¢æ¸¬æ¸¬è©¦å·¥å…·å·²è¼‰å…¥', 'info');
            log('é€™å€‹å·¥å…·å°ˆé–€ç”¨æ–¼æ¸¬è©¦ www.edu.tw çš„å®‰å…¨æª¢æ¸¬åŠŸèƒ½', 'info');
        });
        
        // é é¢é—œé–‰å‰æ¸…ç†
        window.addEventListener('beforeunload', async () => {
            if (eduTwTabId) {
                try {
                    await chrome.tabs.remove(eduTwTabId);
                } catch (error) {
                    // å¿½ç•¥éŒ¯èª¤
                }
            }
        });
    </script>
</body>
</html>