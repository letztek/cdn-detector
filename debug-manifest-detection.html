<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifest æª¢æ¸¬è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .diagnostic-step {
            background: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-unknown { background: #6c757d; }
        
        h1 { color: #333; }
        h2 { color: #007bff; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Manifest æª¢æ¸¬è¨ºæ–·å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·å¹«åŠ©è¨ºæ–·ç‚ºä»€éº¼ CDN Detector æ²’æœ‰æª¢æ¸¬åˆ° manifest æª”æ¡ˆã€‚</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ è¨ºæ–·æ­¥é©Ÿ</h2>
        
        <div class="diagnostic-step">
            <h3>æ­¥é©Ÿ 1ï¼šæª¢æŸ¥æ“´å……åŠŸèƒ½ç‹€æ…‹</h3>
            <button class="test-button" onclick="checkExtensionStatus()">æª¢æŸ¥æ“´å……åŠŸèƒ½</button>
            <div id="extension-status"></div>
        </div>

        <div class="diagnostic-step">
            <h3>æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ CDN æª¢æ¸¬æ˜¯å¦å•Ÿç”¨</h3>
            <p>CDN Detector çš„ webRequest ç›£è½å™¨åªæœ‰åœ¨ CDN æª¢æ¸¬åŠŸèƒ½å•Ÿç”¨æ™‚æ‰æœƒé‹ä½œã€‚</p>
            <button class="test-button" onclick="checkCDNDetection()">æª¢æŸ¥ CDN æª¢æ¸¬ç‹€æ…‹</button>
            <button class="test-button" onclick="enableCDNDetection()">å•Ÿç”¨ CDN æª¢æ¸¬</button>
            <div id="cdn-status"></div>
        </div>

        <div class="diagnostic-step">
            <h3>æ­¥é©Ÿ 3ï¼šæ¸¬è©¦ Manifest æª”æ¡ˆè«‹æ±‚</h3>
            <p>ç™¼é€å¯¦éš›çš„ HTTP è«‹æ±‚ä¾†è§¸ç™¼ webRequest ç›£è½å™¨ã€‚</p>
            <button class="test-button" onclick="testManifestRequest('DASH')">æ¸¬è©¦ DASH</button>
            <button class="test-button" onclick="testManifestRequest('HLS')">æ¸¬è©¦ HLS</button>
            <div id="manifest-test-result"></div>
        </div>

        <div class="diagnostic-step">
            <h3>æ­¥é©Ÿ 4ï¼šæª¢æŸ¥ Console æ—¥èªŒ</h3>
            <p>æŒ‰ F12 é–‹å•Ÿ DevToolsï¼Œåˆ‡æ›åˆ° Console æ¨™ç±¤ï¼Œç„¶å¾ŒåŸ·è¡Œä¸Šè¿°æ¸¬è©¦ã€‚</p>
            <div class="warning">
                <strong>âš ï¸ é‡è¦ï¼š</strong> è«‹ç¢ºä¿åœ¨ Console ä¸­çœ‹åˆ°ä»¥ä¸‹è¨Šæ¯ï¼š
                <ul>
                    <li><code>ğŸ¬ Manifest file detected: [URL]</code></li>
                    <li><code>âœ… DASH/HLS parsing completed</code></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”§ å¸¸è¦‹å•é¡Œè§£æ±º</h2>
        
        <div class="diagnostic-step error">
            <h3>å•é¡Œ 1ï¼šCDN æª¢æ¸¬åŠŸèƒ½æœªå•Ÿç”¨</h3>
            <p><strong>ç—‡ç‹€ï¼š</strong> æ²’æœ‰ä»»ä½• webRequest æ—¥èªŒ</p>
            <p><strong>è§£æ±ºï¼š</strong> é»æ“Šå·¥å…·åˆ—çš„ CDN Detector åœ–ç¤ºï¼Œç¢ºä¿æª¢æ¸¬åŠŸèƒ½å·²é–‹å•Ÿ</p>
        </div>

        <div class="diagnostic-step error">
            <h3>å•é¡Œ 2ï¼šæ“´å……åŠŸèƒ½æ¬Šé™ä¸è¶³</h3>
            <p><strong>ç—‡ç‹€ï¼š</strong> Console å‡ºç¾æ¬Šé™éŒ¯èª¤</p>
            <p><strong>è§£æ±ºï¼š</strong> é‡æ–°è¼‰å…¥æ“´å……åŠŸèƒ½ï¼Œç¢ºèª manifest.json æ¬Šé™è¨­å®šæ­£ç¢º</p>
        </div>

        <div class="diagnostic-step error">
            <h3>å•é¡Œ 3ï¼šCORS é™åˆ¶</h3>
            <p><strong>ç—‡ç‹€ï¼š</strong> ç¶²è·¯è«‹æ±‚å¤±æ•—</p>
            <p><strong>è§£æ±ºï¼š</strong> é€™ä¸å½±éŸ¿ webRequest ç›£è½å™¨ï¼Œæª¢æŸ¥ Console æ˜¯å¦æœ‰æª¢æ¸¬æ—¥èªŒ</p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š å³æ™‚æ—¥èªŒç›£æ§</h2>
        <button class="test-button" onclick="startLogMonitoring()">é–‹å§‹ç›£æ§</button>
        <button class="test-button" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <div id="log-monitor" class="log-output">ç­‰å¾…æ—¥èªŒ...</div>
    </div>

    <script>
        let logBuffer = [];
        let isMonitoring = false;

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClass = status === 'ok' ? 'success' : status === 'error' ? 'error' : 'info';
            const statusIcon = status === 'ok' ? 'âœ…' : status === 'error' ? 'âŒ' : 'â„¹ï¸';
            
            element.innerHTML = `<div class="${statusClass}">${statusIcon} ${message}</div>`;
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logBuffer.push(logEntry);
            
            if (logBuffer.length > 50) {
                logBuffer.shift();
            }
            
            if (isMonitoring) {
                document.getElementById('log-monitor').textContent = logBuffer.join('\n');
            }
        }

        function checkExtensionStatus() {
            addLog('æª¢æŸ¥æ“´å……åŠŸèƒ½ç‹€æ…‹...');
            
            if (typeof chrome === 'undefined') {
                updateStatus('extension-status', 'error', 'âŒ Chrome API ä¸å¯ç”¨');
                addLog('éŒ¯èª¤ï¼šChrome API ä¸å¯ç”¨');
                return;
            }
            
            if (!chrome.runtime) {
                updateStatus('extension-status', 'error', 'âŒ Chrome Runtime API ä¸å¯ç”¨');
                addLog('éŒ¯èª¤ï¼šChrome Runtime API ä¸å¯ç”¨');
                return;
            }
            
            updateStatus('extension-status', 'ok', 'âœ… æ“´å……åŠŸèƒ½ API å¯ç”¨');
            addLog('æˆåŠŸï¼šæ“´å……åŠŸèƒ½ API å¯ç”¨');
        }

        function checkCDNDetection() {
            addLog('æª¢æŸ¥ CDN æª¢æ¸¬ç‹€æ…‹...');
            updateStatus('cdn-status', 'info', 'â„¹ï¸ è«‹é»æ“Šå·¥å…·åˆ—çš„ CDN Detector åœ–ç¤ºæª¢æŸ¥ç‹€æ…‹');
            addLog('æç¤ºï¼šè«‹æ‰‹å‹•æª¢æŸ¥ CDN Detector popup ä¸­çš„æª¢æ¸¬é–‹é—œç‹€æ…‹');
        }

        function enableCDNDetection() {
            addLog('å˜—è©¦å•Ÿç”¨ CDN æª¢æ¸¬...');
            updateStatus('cdn-status', 'info', 'â„¹ï¸ è«‹æ‰‹å‹•é»æ“Š CDN Detector åœ–ç¤ºä¸¦å•Ÿç”¨æª¢æ¸¬åŠŸèƒ½');
            addLog('æç¤ºï¼šéœ€è¦æ‰‹å‹•åœ¨ popup ä¸­å•Ÿç”¨ CDN æª¢æ¸¬åŠŸèƒ½');
        }

        async function testManifestRequest(type) {
            const testUrls = {
                'DASH': 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd',
                'HLS': 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8'
            };
            
            const url = testUrls[type];
            addLog(`é–‹å§‹æ¸¬è©¦ ${type} manifest: ${url}`);
            
            try {
                console.log(`ğŸ§ª æ¸¬è©¦ ${type} manifest æª¢æ¸¬:`, url);
                addLog(`ç™¼é€ ${type} è«‹æ±‚...`);
                
                // ç™¼é€ HEAD è«‹æ±‚ä»¥è§¸ç™¼ webRequest ç›£è½å™¨
                const response = await fetch(url, { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    updateStatus('manifest-test-result', 'ok', 
                        `âœ… ${type} è«‹æ±‚æˆåŠŸ (${response.status})`);
                    addLog(`${type} è«‹æ±‚æˆåŠŸï¼š${response.status} ${response.statusText}`);
                    addLog(`Content-Type: ${response.headers.get('content-type') || 'N/A'}`);
                    addLog('è«‹æª¢æŸ¥ Console æ˜¯å¦æœ‰ "ğŸ¬ Manifest file detected" è¨Šæ¯');
                    
                    // ç­‰å¾…ä¸€ä¸‹è®“ webRequest è™•ç†
                    setTimeout(() => {
                        addLog('å¦‚æœæ²’æœ‰çœ‹åˆ°æª¢æ¸¬è¨Šæ¯ï¼Œå¯èƒ½æ˜¯ï¼š');
                        addLog('1. CDN æª¢æ¸¬åŠŸèƒ½æœªå•Ÿç”¨');
                        addLog('2. webRequest ç›£è½å™¨æœªé‹ä½œ');
                        addLog('3. æª¢æŸ¥ background.js æ˜¯å¦æœ‰éŒ¯èª¤');
                    }, 2000);
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                updateStatus('manifest-test-result', 'error', 
                    `âŒ ${type} è«‹æ±‚å¤±æ•—: ${error.message}`);
                addLog(`${type} è«‹æ±‚å¤±æ•—ï¼š${error.message}`);
                addLog('æ³¨æ„ï¼šå³ä½¿è«‹æ±‚å¤±æ•—ï¼ŒwebRequest ç›£è½å™¨ä»æ‡‰è©²è§¸ç™¼');
            }
        }

        function startLogMonitoring() {
            isMonitoring = true;
            document.getElementById('log-monitor').textContent = logBuffer.join('\n') || 'é–‹å§‹ç›£æ§æ—¥èªŒ...';
            addLog('é–‹å§‹æ—¥èªŒç›£æ§');
        }

        function clearLogs() {
            logBuffer = [];
            document.getElementById('log-monitor').textContent = 'æ—¥èªŒå·²æ¸…é™¤';
            console.clear();
            addLog('æ—¥èªŒå·²æ¸…é™¤');
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            addLog('è¨ºæ–·é é¢è¼‰å…¥å®Œæˆ');
            checkExtensionStatus();
            
            // ç›£è½ console è¨Šæ¯ï¼ˆå¦‚æœå¯èƒ½ï¼‰
            const originalLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('ğŸ¬') || message.includes('Manifest')) {
                    addLog(`Console: ${message}`);
                }
                originalLog.apply(console, args);
            };
        });
    </script>
</body>
</html> 