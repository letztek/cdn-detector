<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifest 檢測診斷工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .diagnostic-step {
            background: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-unknown { background: #6c757d; }
        
        h1 { color: #333; }
        h2 { color: #007bff; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Manifest 檢測診斷工具</h1>
        <p>這個工具幫助診斷為什麼 CDN Detector 沒有檢測到 manifest 檔案。</p>
    </div>

    <div class="container">
        <h2>📋 診斷步驟</h2>
        
        <div class="diagnostic-step">
            <h3>步驟 1：檢查擴充功能狀態</h3>
            <button class="test-button" onclick="checkExtensionStatus()">檢查擴充功能</button>
            <div id="extension-status"></div>
        </div>

        <div class="diagnostic-step">
            <h3>步驟 2：檢查 CDN 檢測是否啟用</h3>
            <p>CDN Detector 的 webRequest 監聽器只有在 CDN 檢測功能啟用時才會運作。</p>
            <button class="test-button" onclick="checkCDNDetection()">檢查 CDN 檢測狀態</button>
            <button class="test-button" onclick="enableCDNDetection()">啟用 CDN 檢測</button>
            <div id="cdn-status"></div>
        </div>

        <div class="diagnostic-step">
            <h3>步驟 3：測試 Manifest 檔案請求</h3>
            <p>發送實際的 HTTP 請求來觸發 webRequest 監聽器。</p>
            <button class="test-button" onclick="testManifestRequest('DASH')">測試 DASH</button>
            <button class="test-button" onclick="testManifestRequest('HLS')">測試 HLS</button>
            <div id="manifest-test-result"></div>
        </div>

        <div class="diagnostic-step">
            <h3>步驟 4：檢查 Console 日誌</h3>
            <p>按 F12 開啟 DevTools，切換到 Console 標籤，然後執行上述測試。</p>
            <div class="warning">
                <strong>⚠️ 重要：</strong> 請確保在 Console 中看到以下訊息：
                <ul>
                    <li><code>🎬 Manifest file detected: [URL]</code></li>
                    <li><code>✅ DASH/HLS parsing completed</code></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🔧 常見問題解決</h2>
        
        <div class="diagnostic-step error">
            <h3>問題 1：CDN 檢測功能未啟用</h3>
            <p><strong>症狀：</strong> 沒有任何 webRequest 日誌</p>
            <p><strong>解決：</strong> 點擊工具列的 CDN Detector 圖示，確保檢測功能已開啟</p>
        </div>

        <div class="diagnostic-step error">
            <h3>問題 2：擴充功能權限不足</h3>
            <p><strong>症狀：</strong> Console 出現權限錯誤</p>
            <p><strong>解決：</strong> 重新載入擴充功能，確認 manifest.json 權限設定正確</p>
        </div>

        <div class="diagnostic-step error">
            <h3>問題 3：CORS 限制</h3>
            <p><strong>症狀：</strong> 網路請求失敗</p>
            <p><strong>解決：</strong> 這不影響 webRequest 監聽器，檢查 Console 是否有檢測日誌</p>
        </div>
    </div>

    <div class="container">
        <h2>📊 即時日誌監控</h2>
        <button class="test-button" onclick="startLogMonitoring()">開始監控</button>
        <button class="test-button" onclick="clearLogs()">清除日誌</button>
        <div id="log-monitor" class="log-output">等待日誌...</div>
    </div>

    <script>
        let logBuffer = [];
        let isMonitoring = false;

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClass = status === 'ok' ? 'success' : status === 'error' ? 'error' : 'info';
            const statusIcon = status === 'ok' ? '✅' : status === 'error' ? '❌' : 'ℹ️';
            
            element.innerHTML = `<div class="${statusClass}">${statusIcon} ${message}</div>`;
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logBuffer.push(logEntry);
            
            if (logBuffer.length > 50) {
                logBuffer.shift();
            }
            
            if (isMonitoring) {
                document.getElementById('log-monitor').textContent = logBuffer.join('\n');
            }
        }

        function checkExtensionStatus() {
            addLog('檢查擴充功能狀態...');
            
            if (typeof chrome === 'undefined') {
                updateStatus('extension-status', 'error', '❌ Chrome API 不可用');
                addLog('錯誤：Chrome API 不可用');
                return;
            }
            
            if (!chrome.runtime) {
                updateStatus('extension-status', 'error', '❌ Chrome Runtime API 不可用');
                addLog('錯誤：Chrome Runtime API 不可用');
                return;
            }
            
            updateStatus('extension-status', 'ok', '✅ 擴充功能 API 可用');
            addLog('成功：擴充功能 API 可用');
        }

        function checkCDNDetection() {
            addLog('檢查 CDN 檢測狀態...');
            updateStatus('cdn-status', 'info', 'ℹ️ 請點擊工具列的 CDN Detector 圖示檢查狀態');
            addLog('提示：請手動檢查 CDN Detector popup 中的檢測開關狀態');
        }

        function enableCDNDetection() {
            addLog('嘗試啟用 CDN 檢測...');
            updateStatus('cdn-status', 'info', 'ℹ️ 請手動點擊 CDN Detector 圖示並啟用檢測功能');
            addLog('提示：需要手動在 popup 中啟用 CDN 檢測功能');
        }

        async function testManifestRequest(type) {
            const testUrls = {
                'DASH': 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd',
                'HLS': 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8'
            };
            
            const url = testUrls[type];
            addLog(`開始測試 ${type} manifest: ${url}`);
            
            try {
                console.log(`🧪 測試 ${type} manifest 檢測:`, url);
                addLog(`發送 ${type} 請求...`);
                
                // 發送 HEAD 請求以觸發 webRequest 監聽器
                const response = await fetch(url, { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    updateStatus('manifest-test-result', 'ok', 
                        `✅ ${type} 請求成功 (${response.status})`);
                    addLog(`${type} 請求成功：${response.status} ${response.statusText}`);
                    addLog(`Content-Type: ${response.headers.get('content-type') || 'N/A'}`);
                    addLog('請檢查 Console 是否有 "🎬 Manifest file detected" 訊息');
                    
                    // 等待一下讓 webRequest 處理
                    setTimeout(() => {
                        addLog('如果沒有看到檢測訊息，可能是：');
                        addLog('1. CDN 檢測功能未啟用');
                        addLog('2. webRequest 監聽器未運作');
                        addLog('3. 檢查 background.js 是否有錯誤');
                    }, 2000);
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                updateStatus('manifest-test-result', 'error', 
                    `❌ ${type} 請求失敗: ${error.message}`);
                addLog(`${type} 請求失敗：${error.message}`);
                addLog('注意：即使請求失敗，webRequest 監聽器仍應該觸發');
            }
        }

        function startLogMonitoring() {
            isMonitoring = true;
            document.getElementById('log-monitor').textContent = logBuffer.join('\n') || '開始監控日誌...';
            addLog('開始日誌監控');
        }

        function clearLogs() {
            logBuffer = [];
            document.getElementById('log-monitor').textContent = '日誌已清除';
            console.clear();
            addLog('日誌已清除');
        }

        // 頁面載入時自動檢查
        window.addEventListener('load', () => {
            addLog('診斷頁面載入完成');
            checkExtensionStatus();
            
            // 監聽 console 訊息（如果可能）
            const originalLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('🎬') || message.includes('Manifest')) {
                    addLog(`Console: ${message}`);
                }
                originalLog.apply(console, args);
            };
        });
    </script>
</body>
</html> 