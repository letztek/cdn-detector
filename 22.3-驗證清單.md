# Task 22.3 - Content Script Video Element Listener 驗證清單

## 📋 功能驗證項目

### ✅ Content Script 注入與載入
- [ ] **Manifest 配置檢查**
  - [ ] `content_scripts` 陣列包含 `video-quality-monitor.js`
  - [ ] `matches: ["<all_urls>"]` 允許在所有網站執行
  - [ ] `run_at: "document_end"` 確保 DOM 載入完成後執行
  - [ ] `all_frames: true` 支援 iframe 中的視頻

- [ ] **Content Script 載入確認**
  - [ ] 在任意網頁的 Console 中看到 `[Video Quality Monitor]` 日誌
  - [ ] 顯示平台檢測結果（YouTube, Netflix, Twitch, Vimeo, HTML5）
  - [ ] 報告載入狀態到 background script

### ✅ 視頻元素檢測
- [ ] **HTML5 視頻檢測**
  - [ ] 檢測標準 `<video>` 元素
  - [ ] 檢測動態載入的視頻元素
  - [ ] 檢測 iframe 中的視頻（如果可訪問）
  - [ ] 檢測 `<object>` 和 `<embed>` 元素

- [ ] **平台特定檢測**
  - [ ] YouTube 播放器檢測
  - [ ] Netflix 播放器檢測
  - [ ] Twitch 播放器檢測
  - [ ] Vimeo 播放器檢測
  - [ ] 通用 HTML5 播放器檢測

### ✅ 視頻事件監聽
- [ ] **基本播放事件**
  - [ ] `play` - 播放開始
  - [ ] `pause` - 播放暫停
  - [ ] `ended` - 播放結束
  - [ ] `error` - 播放錯誤

- [ ] **載入相關事件**
  - [ ] `loadstart` - 開始載入
  - [ ] `loadeddata` - 數據載入完成
  - [ ] `loadedmetadata` - 元數據載入完成
  - [ ] `canplay` - 可以開始播放
  - [ ] `canplaythrough` - 可以流暢播放

- [ ] **品質相關事件**
  - [ ] `waiting` - 緩衝等待
  - [ ] `seeking` - 跳轉中
  - [ ] `seeked` - 跳轉完成
  - [ ] `timeupdate` - 時間更新
  - [ ] `ratechange` - 播放速度變化

### ✅ 數據收集與監控
- [ ] **基本視頻資訊**
  - [ ] 視頻來源 URL (`src`, `currentSrc`)
  - [ ] 視頻尺寸 (`videoWidth`, `videoHeight`)
  - [ ] 播放時長 (`duration`)
  - [ ] 當前播放時間 (`currentTime`)
  - [ ] 播放狀態 (`paused`, `ended`)

- [ ] **網路與緩衝狀態**
  - [ ] 網路狀態 (`networkState`)
  - [ ] 準備狀態 (`readyState`)
  - [ ] 緩衝範圍 (`buffered`)
  - [ ] 錯誤資訊 (`error`)

- [ ] **播放品質指標**
  - [ ] 丟幀數據 (`droppedVideoFrames`)
  - [ ] 總幀數 (`totalVideoFrames`)
  - [ ] 損壞幀數 (`corruptedVideoFrames`)
  - [ ] 創建時間 (`creationTime`)

### ✅ 與 Background Script 通信
- [ ] **消息發送**
  - [ ] `VIDEO_QUALITY_UPDATE` - 發送視頻品質更新
  - [ ] `VIDEO_QUALITY_LOG` - 發送日誌訊息
  - [ ] 正確處理連接錯誤和斷線情況

- [ ] **數據同步**
  - [ ] 定期發送視頻監控數據
  - [ ] 頁面卸載時清理數據
  - [ ] URL 變化時重新初始化

### ✅ 動態內容處理
- [ ] **MutationObserver**
  - [ ] 監控 DOM 變化
  - [ ] 檢測新增的視頻元素
  - [ ] 自動開始監控新視頻

- [ ] **SPA 支援**
  - [ ] 檢測 URL 變化
  - [ ] 重新初始化監控
  - [ ] 清理舊的監控數據

### ✅ 錯誤處理與清理
- [ ] **記憶體管理**
  - [ ] 限制事件記錄數量（1000 個）
  - [ ] 限制指標記錄數量（200 個）
  - [ ] 清理無效的監控

- [ ] **事件監聽器清理**
  - [ ] 頁面卸載時移除監聽器
  - [ ] 視頻元素移除時清理監控
  - [ ] 防止記憶體洩漏

## 🧪 測試步驟

### 1. 基本功能測試
```bash
# 1. 重新載入擴展
chrome://extensions/ → 重新載入 CDN Detector

# 2. 開啟測試頁面
開啟任意包含視頻的網站（YouTube, Netflix 等）

# 3. 檢查 Console 日誌
按 F12 → Console 標籤
預期看到：[Video Quality Monitor] [INFO] 視頻品質監控已載入 - 平台: youtube
```

### 2. 視頻檢測測試
```bash
# 1. 開啟 HTML5 視頻測試頁面
開啟 test-video.html 或 test-video-simple.html

# 2. 檢查檢測結果
Console 應顯示：
- "Starting comprehensive video element search..."
- "Total video elements found: X"
- 每個檢測到的視頻的詳細資訊

# 3. 播放視頻
點擊播放按鈕
預期看到播放事件日誌
```

### 3. 平台特定測試
```bash
# YouTube 測試
1. 開啟 https://www.youtube.com/watch?v=任意視頻
2. 檢查 Console：平台應顯示為 "youtube"
3. 確認檢測到 YouTube 播放器

# Netflix 測試（需要帳號）
1. 開啟 Netflix 視頻頁面
2. 檢查平台檢測為 "netflix"

# Twitch 測試
1. 開啟 https://www.twitch.tv/任意直播
2. 檢查平台檢測為 "twitch"
```

### 4. Background Script 通信測試
```bash
# 在任意有視頻的頁面 Console 中執行：
chrome.runtime.sendMessage({type: 'GET_VIDEO_QUALITY_DATA'}, console.log);

# 預期返回：
{
  success: true,
  data: {
    currentTab: {
      tabId: number,
      videos: {...},
      totalVideos: number,
      activeVideos: number
    }
  }
}
```

### 5. 動態內容測試
```bash
# 1. 開啟 SPA 網站（如 YouTube）
# 2. 瀏覽不同視頻
# 3. 確認每次 URL 變化都重新初始化監控
# 4. 檢查 Console 是否有 "URL 變化檢測到，重新初始化監控" 訊息
```

## 🔍 除錯檢查項目

### Console 日誌檢查
```javascript
// 成功載入時應該看到：
[Video Quality Monitor] [INFO] 視頻品質監控已載入 - 平台: youtube
[Video Quality Monitor] [INFO] 開始監控視頻元素: youtube_xxx
[Video Quality Monitor] [INFO] Total video elements found: 1

// 視頻事件時應該看到：
[Video Quality Monitor] [INFO] 視頻事件 play - youtube_xxx
[Video Quality Monitor] [INFO] 視頻事件 timeupdate - youtube_xxx
```

### Background Script 檢查
```javascript
// 在擴展的 Service Worker Console 中檢查：
// 1. 是否收到 VIDEO_QUALITY_UPDATE 消息
// 2. 是否正確處理視頻品質數據
// 3. 是否有錯誤日誌
```

### 數據結構檢查
```javascript
// 在網頁 Console 中檢查 content script 狀態：
// 注意：這些變數在 IIFE 中，無法直接訪問
// 但可以通過 chrome.runtime.sendMessage 獲取數據

chrome.runtime.sendMessage({type: 'GET_VIDEO_QUALITY_DATA'}, (response) => {
  console.log('Video Quality Data:', response);
});
```

## ⚠️ 常見問題排除

### 1. Content Script 未載入
- **症狀**：Console 中沒有 `[Video Quality Monitor]` 日誌
- **檢查**：manifest.json 中 content_scripts 配置是否正確
- **解決**：重新載入擴展，確認配置無誤

### 2. 視頻檢測失敗
- **症狀**：顯示 "Total video elements found: 0"
- **原因**：視頻可能在 iframe 中或動態載入
- **解決**：等待頁面完全載入，或檢查是否為跨域 iframe

### 3. 事件監聽器無效
- **症狀**：播放視頻但沒有事件日誌
- **檢查**：視頻元素是否正確綁定事件監聽器
- **解決**：確認視頻元素可訪問且不在跨域 iframe 中

### 4. Background Script 通信失敗
- **症狀**：`chrome.runtime.sendMessage` 返回錯誤
- **檢查**：擴展是否正確載入，Service Worker 是否活躍
- **解決**：重新載入擴展，檢查 background.js 是否有錯誤

### 5. 記憶體洩漏
- **症狀**：長時間使用後瀏覽器變慢
- **檢查**：事件監聽器是否正確清理
- **解決**：確認頁面卸載時清理所有監聽器

## 📊 效能指標

### 監控開銷
- Content Script 載入時間：< 100ms
- 視頻檢測時間：< 50ms
- 事件處理時間：< 1ms
- 記憶體使用：每個視頻 < 10KB

### 相容性
- 支援所有現代瀏覽器（Chrome 88+）
- 支援 Manifest V3
- 支援跨平台（YouTube, Netflix, Twitch, Vimeo）
- 支援動態載入內容（SPA）

## ✅ 驗證完成標準

Task 22.3 被認為成功實現當：

1. ✅ Content Script 正確注入到所有網頁
2. ✅ 能檢測各種類型的視頻元素
3. ✅ 正確監聽所有重要的視頻事件
4. ✅ 準確收集視頻品質數據
5. ✅ 與 background script 通信正常
6. ✅ 支援動態內容和 SPA
7. ✅ 錯誤處理和記憶體管理有效
8. ✅ 在多個平台測試通過

---

**注意**：此任務是視頻品質監控系統的核心組件，必須確保在各種網站和視頻播放器上都能穩定工作。 