<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS 計算測試 - ID 穩定性驗證</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .video-container {
            text-align: center;
            margin-bottom: 20px;
        }
        video {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a87;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .info-box p {
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .log-container {
            background: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #61dafb; }
        .log-success { color: #98fb98; }
        .log-warning { color: #ffd700; }
        .log-error { color: #ff6b6b; }
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .metrics-table th,
        .metrics-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        .metrics-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .metrics-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 FPS 計算測試 - ID 穩定性驗證</h1>
        <p>此頁面用於測試 video-quality-monitor.js 中的 FPS 計算功能，特別是 Video ID 穩定性問題的修正。</p>
        
        <div class="video-container">
            <video id="testVideo" controls crossorigin="anonymous">
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                您的瀏覽器不支援 video 標籤。
            </video>
        </div>
        
        <div class="controls">
            <button id="startTest">開始測試</button>
            <button id="checkVideoId">檢查 Video ID</button>
            <button id="checkFPS">檢查 FPS 計算</button>
            <button id="clearLogs">清除日誌</button>
            <button id="exportData">匯出數據</button>
        </div>
    </div>
    
    <div class="info-grid">
        <div class="info-box">
            <h3>📊 Video ID 追蹤</h3>
            <p id="videoIdInfo">等待檢查...</p>
        </div>
        
        <div class="info-box">
            <h3>🎬 FPS 計算狀態</h3>
            <p id="fpsInfo">等待檢查...</p>
        </div>
        
        <div class="info-box">
            <h3>📈 數據收集狀態</h3>
            <p id="dataCollectionInfo">等待檢查...</p>
        </div>
        
        <div class="info-box">
            <h3>🔧 診斷資訊</h3>
            <p id="diagnosticInfo">等待檢查...</p>
        </div>
    </div>
    
    <div class="container">
        <h3>📋 詳細 FPS 計算數據</h3>
        <table class="metrics-table" id="fpsMetricsTable">
            <thead>
                <tr>
                    <th>時間</th>
                    <th>Video ID</th>
                    <th>總幀數</th>
                    <th>時間差(秒)</th>
                    <th>幀差</th>
                    <th>計算FPS</th>
                    <th>來源</th>
                    <th>樣本數</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <div class="container">
        <h3>📝 即時日誌</h3>
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">等待開始測試...</div>
        </div>
    </div>

    <script>
        // 注入 video-quality-monitor.js
        const script = document.createElement('script');
        script.src = 'video-quality-monitor.js';
        document.head.appendChild(script);
        
        let testInterval;
        let logContainer;
        let testStartTime;
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            
            // 監聽來自 content script 的日誌
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'VIDEO_QUALITY_LOG') {
                    addLog(event.data.message, event.data.level || 'info');
                }
            });
            
            document.getElementById('startTest').addEventListener('click', startTest);
            document.getElementById('checkVideoId').addEventListener('click', checkVideoId);
            document.getElementById('checkFPS').addEventListener('click', checkFPS);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            document.getElementById('exportData').addEventListener('click', exportData);
        });
        
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function startTest() {
            testStartTime = Date.now();
            addLog('🚀 開始 FPS 計算測試', 'info');
            addLog('📹 請播放視頻以開始收集數據', 'info');
            
            // 定期檢查狀態
            if (testInterval) {
                clearInterval(testInterval);
            }
            
            testInterval = setInterval(() => {
                checkVideoId();
                checkFPS();
                updateDataCollectionInfo();
                updateDiagnosticInfo();
            }, 2000);
            
            addLog('⏰ 開始每2秒檢查一次狀態', 'info');
        }
        
        function checkVideoId() {
            const video = document.getElementById('testVideo');
            if (!video) {
                document.getElementById('videoIdInfo').innerHTML = '<span class="status error">找不到視頻元素</span>';
                return;
            }
            
            // 檢查是否有保存的 ID
            const savedId = video.dataset.videoMonitorId;
            
            // 模擬調用 generateVideoId 函數
            let generatedId = '';
            if (window.generateVideoId) {
                generatedId = window.generateVideoId(video);
            }
            
            const info = `
                保存的ID: ${savedId || '無'}<br>
                生成的ID: ${generatedId || '無'}<br>
                ID一致: <span class="status ${savedId === generatedId ? 'success' : 'error'}">${savedId === generatedId ? '是' : '否'}</span><br>
                視頻來源: ${video.src || video.currentSrc || '無'}<br>
                視頻尺寸: ${video.videoWidth || 0}x${video.videoHeight || 0}
            `;
            
            document.getElementById('videoIdInfo').innerHTML = info;
            
            if (savedId && generatedId && savedId === generatedId) {
                addLog(`✅ Video ID 穩定: ${savedId}`, 'success');
            } else if (savedId !== generatedId) {
                addLog(`❌ Video ID 不一致! 保存: ${savedId}, 生成: ${generatedId}`, 'error');
            }
        }
        
        function checkFPS() {
            // 嘗試從全域變數獲取數據
            if (window.videoQualityData && window.videoQualityData.videos) {
                const videos = window.videoQualityData.videos;
                addLog(`📊 找到 ${videos.size} 個監控中的視頻`, 'info');
                
                let fpsInfo = '';
                let hasValidFPS = false;
                
                videos.forEach((videoData, videoId) => {
                    const metrics = videoData.metrics || [];
                    const latestMetric = metrics[metrics.length - 1];
                    
                    if (latestMetric) {
                        const fps = latestMetric.frameRate;
                        const fpsSource = latestMetric.frameRateSource || '未知';
                        const samples = latestMetric.frameRateSamples || 0;
                        
                        fpsInfo += `
                            Video ID: ${videoId}<br>
                            FPS: ${fps || 'N/A'}<br>
                            來源: ${fpsSource}<br>
                            樣本數: ${samples}<br>
                            指標數量: ${metrics.length}<br>
                        `;
                        
                        if (fps && fps > 0) {
                            hasValidFPS = true;
                            addLog(`📈 FPS 計算成功: ${fps} fps (來源: ${fpsSource}, 樣本: ${samples})`, 'success');
                            
                            // 更新詳細表格
                            updateFPSTable(videoId, latestMetric);
                        } else {
                            addLog(`⚠️ FPS 尚未計算出來 (來源: ${fpsSource})`, 'warning');
                        }
                    } else {
                        fpsInfo += `Video ID: ${videoId}<br>指標數量: 0<br>`;
                        addLog(`📊 視頻 ${videoId} 尚無指標數據`, 'info');
                    }
                });
                
                if (!fpsInfo) {
                    fpsInfo = '<span class="status warning">尚無視頻數據</span>';
                }
                
                document.getElementById('fpsInfo').innerHTML = fpsInfo;
                
                if (hasValidFPS) {
                    document.getElementById('fpsInfo').innerHTML += '<br><span class="status success">FPS 計算正常</span>';
                }
            } else {
                document.getElementById('fpsInfo').innerHTML = '<span class="status error">無法訪問 videoQualityData</span>';
                addLog('❌ 無法訪問 window.videoQualityData', 'error');
            }
        }
        
        function updateFPSTable(videoId, metric) {
            const table = document.getElementById('fpsMetricsTable').getElementsByTagName('tbody')[0];
            const row = table.insertRow(0); // 插入到頂部
            
            const timestamp = new Date(metric.timestamp).toLocaleTimeString();
            const totalFrames = metric.playbackQuality?.totalVideoFrames || 'N/A';
            const fps = metric.frameRate || 'N/A';
            const source = metric.frameRateSource || 'N/A';
            const samples = metric.frameRateSamples || 'N/A';
            
            // 計算時間差和幀差（如果有詳細資訊）
            let timeDiff = 'N/A';
            let frameDiff = 'N/A';
            
            if (metric.frameRateDetails && metric.frameRateDetails.samples && metric.frameRateDetails.samples.length > 0) {
                const lastSample = metric.frameRateDetails.samples[metric.frameRateDetails.samples.length - 1];
                timeDiff = lastSample.timeDiff || 'N/A';
                frameDiff = lastSample.frameDiff || 'N/A';
            }
            
            row.innerHTML = `
                <td>${timestamp}</td>
                <td style="font-size: 10px;">${videoId.substring(0, 20)}...</td>
                <td>${totalFrames}</td>
                <td>${timeDiff}</td>
                <td>${frameDiff}</td>
                <td><strong>${fps}</strong></td>
                <td>${source}</td>
                <td>${samples}</td>
            `;
            
            // 限制表格行數
            while (table.rows.length > 20) {
                table.deleteRow(table.rows.length - 1);
            }
        }
        
        function updateDataCollectionInfo() {
            if (window.videoQualityData) {
                const data = window.videoQualityData;
                const totalVideos = data.videos ? data.videos.size : 0;
                let totalMetrics = 0;
                let totalEvents = 0;
                
                if (data.videos) {
                    data.videos.forEach(videoData => {
                        totalMetrics += (videoData.metrics || []).length;
                        totalEvents += (videoData.events || []).length;
                    });
                }
                
                const info = `
                    監控視頻數: ${totalVideos}<br>
                    總指標數: ${totalMetrics}<br>
                    總事件數: ${totalEvents}<br>
                    運行時間: ${Math.round((Date.now() - (testStartTime || Date.now())) / 1000)}秒
                `;
                
                document.getElementById('dataCollectionInfo').innerHTML = info;
            }
        }
        
        function updateDiagnosticInfo() {
            const video = document.getElementById('testVideo');
            if (!video) return;
            
            const info = `
                播放狀態: ${video.paused ? '暫停' : '播放中'}<br>
                當前時間: ${video.currentTime?.toFixed(2) || 0}秒<br>
                總時長: ${video.duration?.toFixed(2) || 0}秒<br>
                就緒狀態: ${video.readyState}<br>
                網路狀態: ${video.networkState}<br>
                支援 getVideoPlaybackQuality: ${video.getVideoPlaybackQuality ? '是' : '否'}
            `;
            
            document.getElementById('diagnosticInfo').innerHTML = info;
        }
        
        function clearLogs() {
            logContainer.innerHTML = '<div class="log-entry log-info">日誌已清除</div>';
            
            // 清除表格
            const table = document.getElementById('fpsMetricsTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
        }
        
        function exportData() {
            if (window.videoQualityData) {
                const data = {
                    timestamp: new Date().toISOString(),
                    testDuration: Date.now() - (testStartTime || Date.now()),
                    videoQualityData: {}
                };
                
                // 轉換 Map 為普通物件
                if (window.videoQualityData.videos) {
                    window.videoQualityData.videos.forEach((videoData, videoId) => {
                        data.videoQualityData[videoId] = {
                            id: videoData.id,
                            startTime: videoData.startTime,
                            metrics: videoData.metrics || [],
                            events: videoData.events || [],
                            active: videoData.active
                        };
                    });
                }
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fps-test-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addLog('📁 數據已匯出', 'success');
            } else {
                addLog('❌ 無數據可匯出', 'error');
            }
        }
        
        // 每30秒自動檢查一次
        setInterval(() => {
            if (testInterval) {
                addLog('🔄 自動檢查狀態...', 'info');
            }
        }, 30000);
    </script>
</body>
</html>
