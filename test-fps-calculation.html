<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS è¨ˆç®—æ¸¬è©¦ - ID ç©©å®šæ€§é©—è­‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .video-container {
            text-align: center;
            margin-bottom: 20px;
        }
        video {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a87;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .info-box p {
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .log-container {
            background: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #61dafb; }
        .log-success { color: #98fb98; }
        .log-warning { color: #ffd700; }
        .log-error { color: #ff6b6b; }
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .metrics-table th,
        .metrics-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        .metrics-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .metrics-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ FPS è¨ˆç®—æ¸¬è©¦ - ID ç©©å®šæ€§é©—è­‰</h1>
        <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦ video-quality-monitor.js ä¸­çš„ FPS è¨ˆç®—åŠŸèƒ½ï¼Œç‰¹åˆ¥æ˜¯ Video ID ç©©å®šæ€§å•é¡Œçš„ä¿®æ­£ã€‚</p>
        
        <div class="video-container">
            <video id="testVideo" controls crossorigin="anonymous">
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ video æ¨™ç±¤ã€‚
            </video>
        </div>
        
        <div class="controls">
            <button id="startTest">é–‹å§‹æ¸¬è©¦</button>
            <button id="checkVideoId">æª¢æŸ¥ Video ID</button>
            <button id="checkFPS">æª¢æŸ¥ FPS è¨ˆç®—</button>
            <button id="clearLogs">æ¸…é™¤æ—¥èªŒ</button>
            <button id="exportData">åŒ¯å‡ºæ•¸æ“š</button>
        </div>
    </div>
    
    <div class="info-grid">
        <div class="info-box">
            <h3>ğŸ“Š Video ID è¿½è¹¤</h3>
            <p id="videoIdInfo">ç­‰å¾…æª¢æŸ¥...</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ¬ FPS è¨ˆç®—ç‹€æ…‹</h3>
            <p id="fpsInfo">ç­‰å¾…æª¢æŸ¥...</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ“ˆ æ•¸æ“šæ”¶é›†ç‹€æ…‹</h3>
            <p id="dataCollectionInfo">ç­‰å¾…æª¢æŸ¥...</p>
        </div>
        
        <div class="info-box">
            <h3>ğŸ”§ è¨ºæ–·è³‡è¨Š</h3>
            <p id="diagnosticInfo">ç­‰å¾…æª¢æŸ¥...</p>
        </div>
    </div>
    
    <div class="container">
        <h3>ğŸ“‹ è©³ç´° FPS è¨ˆç®—æ•¸æ“š</h3>
        <table class="metrics-table" id="fpsMetricsTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>Video ID</th>
                    <th>ç¸½å¹€æ•¸</th>
                    <th>æ™‚é–“å·®(ç§’)</th>
                    <th>å¹€å·®</th>
                    <th>è¨ˆç®—FPS</th>
                    <th>ä¾†æº</th>
                    <th>æ¨£æœ¬æ•¸</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <div class="container">
        <h3>ğŸ“ å³æ™‚æ—¥èªŒ</h3>
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">ç­‰å¾…é–‹å§‹æ¸¬è©¦...</div>
        </div>
    </div>

    <script>
        // æ³¨å…¥ video-quality-monitor.js
        const script = document.createElement('script');
        script.src = 'video-quality-monitor.js';
        document.head.appendChild(script);
        
        let testInterval;
        let logContainer;
        let testStartTime;
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            
            // ç›£è½ä¾†è‡ª content script çš„æ—¥èªŒ
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'VIDEO_QUALITY_LOG') {
                    addLog(event.data.message, event.data.level || 'info');
                }
            });
            
            document.getElementById('startTest').addEventListener('click', startTest);
            document.getElementById('checkVideoId').addEventListener('click', checkVideoId);
            document.getElementById('checkFPS').addEventListener('click', checkFPS);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            document.getElementById('exportData').addEventListener('click', exportData);
        });
        
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function startTest() {
            testStartTime = Date.now();
            addLog('ğŸš€ é–‹å§‹ FPS è¨ˆç®—æ¸¬è©¦', 'info');
            addLog('ğŸ“¹ è«‹æ’­æ”¾è¦–é »ä»¥é–‹å§‹æ”¶é›†æ•¸æ“š', 'info');
            
            // å®šæœŸæª¢æŸ¥ç‹€æ…‹
            if (testInterval) {
                clearInterval(testInterval);
            }
            
            testInterval = setInterval(() => {
                checkVideoId();
                checkFPS();
                updateDataCollectionInfo();
                updateDiagnosticInfo();
            }, 2000);
            
            addLog('â° é–‹å§‹æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡ç‹€æ…‹', 'info');
        }
        
        function checkVideoId() {
            const video = document.getElementById('testVideo');
            if (!video) {
                document.getElementById('videoIdInfo').innerHTML = '<span class="status error">æ‰¾ä¸åˆ°è¦–é »å…ƒç´ </span>';
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ ID
            const savedId = video.dataset.videoMonitorId;
            
            // æ¨¡æ“¬èª¿ç”¨ generateVideoId å‡½æ•¸
            let generatedId = '';
            if (window.generateVideoId) {
                generatedId = window.generateVideoId(video);
            }
            
            const info = `
                ä¿å­˜çš„ID: ${savedId || 'ç„¡'}<br>
                ç”Ÿæˆçš„ID: ${generatedId || 'ç„¡'}<br>
                IDä¸€è‡´: <span class="status ${savedId === generatedId ? 'success' : 'error'}">${savedId === generatedId ? 'æ˜¯' : 'å¦'}</span><br>
                è¦–é »ä¾†æº: ${video.src || video.currentSrc || 'ç„¡'}<br>
                è¦–é »å°ºå¯¸: ${video.videoWidth || 0}x${video.videoHeight || 0}
            `;
            
            document.getElementById('videoIdInfo').innerHTML = info;
            
            if (savedId && generatedId && savedId === generatedId) {
                addLog(`âœ… Video ID ç©©å®š: ${savedId}`, 'success');
            } else if (savedId !== generatedId) {
                addLog(`âŒ Video ID ä¸ä¸€è‡´! ä¿å­˜: ${savedId}, ç”Ÿæˆ: ${generatedId}`, 'error');
            }
        }
        
        function checkFPS() {
            // å˜—è©¦å¾å…¨åŸŸè®Šæ•¸ç²å–æ•¸æ“š
            if (window.videoQualityData && window.videoQualityData.videos) {
                const videos = window.videoQualityData.videos;
                addLog(`ğŸ“Š æ‰¾åˆ° ${videos.size} å€‹ç›£æ§ä¸­çš„è¦–é »`, 'info');
                
                let fpsInfo = '';
                let hasValidFPS = false;
                
                videos.forEach((videoData, videoId) => {
                    const metrics = videoData.metrics || [];
                    const latestMetric = metrics[metrics.length - 1];
                    
                    if (latestMetric) {
                        const fps = latestMetric.frameRate;
                        const fpsSource = latestMetric.frameRateSource || 'æœªçŸ¥';
                        const samples = latestMetric.frameRateSamples || 0;
                        
                        fpsInfo += `
                            Video ID: ${videoId}<br>
                            FPS: ${fps || 'N/A'}<br>
                            ä¾†æº: ${fpsSource}<br>
                            æ¨£æœ¬æ•¸: ${samples}<br>
                            æŒ‡æ¨™æ•¸é‡: ${metrics.length}<br>
                        `;
                        
                        if (fps && fps > 0) {
                            hasValidFPS = true;
                            addLog(`ğŸ“ˆ FPS è¨ˆç®—æˆåŠŸ: ${fps} fps (ä¾†æº: ${fpsSource}, æ¨£æœ¬: ${samples})`, 'success');
                            
                            // æ›´æ–°è©³ç´°è¡¨æ ¼
                            updateFPSTable(videoId, latestMetric);
                        } else {
                            addLog(`âš ï¸ FPS å°šæœªè¨ˆç®—å‡ºä¾† (ä¾†æº: ${fpsSource})`, 'warning');
                        }
                    } else {
                        fpsInfo += `Video ID: ${videoId}<br>æŒ‡æ¨™æ•¸é‡: 0<br>`;
                        addLog(`ğŸ“Š è¦–é » ${videoId} å°šç„¡æŒ‡æ¨™æ•¸æ“š`, 'info');
                    }
                });
                
                if (!fpsInfo) {
                    fpsInfo = '<span class="status warning">å°šç„¡è¦–é »æ•¸æ“š</span>';
                }
                
                document.getElementById('fpsInfo').innerHTML = fpsInfo;
                
                if (hasValidFPS) {
                    document.getElementById('fpsInfo').innerHTML += '<br><span class="status success">FPS è¨ˆç®—æ­£å¸¸</span>';
                }
            } else {
                document.getElementById('fpsInfo').innerHTML = '<span class="status error">ç„¡æ³•è¨ªå• videoQualityData</span>';
                addLog('âŒ ç„¡æ³•è¨ªå• window.videoQualityData', 'error');
            }
        }
        
        function updateFPSTable(videoId, metric) {
            const table = document.getElementById('fpsMetricsTable').getElementsByTagName('tbody')[0];
            const row = table.insertRow(0); // æ’å…¥åˆ°é ‚éƒ¨
            
            const timestamp = new Date(metric.timestamp).toLocaleTimeString();
            const totalFrames = metric.playbackQuality?.totalVideoFrames || 'N/A';
            const fps = metric.frameRate || 'N/A';
            const source = metric.frameRateSource || 'N/A';
            const samples = metric.frameRateSamples || 'N/A';
            
            // è¨ˆç®—æ™‚é–“å·®å’Œå¹€å·®ï¼ˆå¦‚æœæœ‰è©³ç´°è³‡è¨Šï¼‰
            let timeDiff = 'N/A';
            let frameDiff = 'N/A';
            
            if (metric.frameRateDetails && metric.frameRateDetails.samples && metric.frameRateDetails.samples.length > 0) {
                const lastSample = metric.frameRateDetails.samples[metric.frameRateDetails.samples.length - 1];
                timeDiff = lastSample.timeDiff || 'N/A';
                frameDiff = lastSample.frameDiff || 'N/A';
            }
            
            row.innerHTML = `
                <td>${timestamp}</td>
                <td style="font-size: 10px;">${videoId.substring(0, 20)}...</td>
                <td>${totalFrames}</td>
                <td>${timeDiff}</td>
                <td>${frameDiff}</td>
                <td><strong>${fps}</strong></td>
                <td>${source}</td>
                <td>${samples}</td>
            `;
            
            // é™åˆ¶è¡¨æ ¼è¡Œæ•¸
            while (table.rows.length > 20) {
                table.deleteRow(table.rows.length - 1);
            }
        }
        
        function updateDataCollectionInfo() {
            if (window.videoQualityData) {
                const data = window.videoQualityData;
                const totalVideos = data.videos ? data.videos.size : 0;
                let totalMetrics = 0;
                let totalEvents = 0;
                
                if (data.videos) {
                    data.videos.forEach(videoData => {
                        totalMetrics += (videoData.metrics || []).length;
                        totalEvents += (videoData.events || []).length;
                    });
                }
                
                const info = `
                    ç›£æ§è¦–é »æ•¸: ${totalVideos}<br>
                    ç¸½æŒ‡æ¨™æ•¸: ${totalMetrics}<br>
                    ç¸½äº‹ä»¶æ•¸: ${totalEvents}<br>
                    é‹è¡Œæ™‚é–“: ${Math.round((Date.now() - (testStartTime || Date.now())) / 1000)}ç§’
                `;
                
                document.getElementById('dataCollectionInfo').innerHTML = info;
            }
        }
        
        function updateDiagnosticInfo() {
            const video = document.getElementById('testVideo');
            if (!video) return;
            
            const info = `
                æ’­æ”¾ç‹€æ…‹: ${video.paused ? 'æš«åœ' : 'æ’­æ”¾ä¸­'}<br>
                ç•¶å‰æ™‚é–“: ${video.currentTime?.toFixed(2) || 0}ç§’<br>
                ç¸½æ™‚é•·: ${video.duration?.toFixed(2) || 0}ç§’<br>
                å°±ç·’ç‹€æ…‹: ${video.readyState}<br>
                ç¶²è·¯ç‹€æ…‹: ${video.networkState}<br>
                æ”¯æ´ getVideoPlaybackQuality: ${video.getVideoPlaybackQuality ? 'æ˜¯' : 'å¦'}
            `;
            
            document.getElementById('diagnosticInfo').innerHTML = info;
        }
        
        function clearLogs() {
            logContainer.innerHTML = '<div class="log-entry log-info">æ—¥èªŒå·²æ¸…é™¤</div>';
            
            // æ¸…é™¤è¡¨æ ¼
            const table = document.getElementById('fpsMetricsTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
        }
        
        function exportData() {
            if (window.videoQualityData) {
                const data = {
                    timestamp: new Date().toISOString(),
                    testDuration: Date.now() - (testStartTime || Date.now()),
                    videoQualityData: {}
                };
                
                // è½‰æ› Map ç‚ºæ™®é€šç‰©ä»¶
                if (window.videoQualityData.videos) {
                    window.videoQualityData.videos.forEach((videoData, videoId) => {
                        data.videoQualityData[videoId] = {
                            id: videoData.id,
                            startTime: videoData.startTime,
                            metrics: videoData.metrics || [],
                            events: videoData.events || [],
                            active: videoData.active
                        };
                    });
                }
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fps-test-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addLog('ğŸ“ æ•¸æ“šå·²åŒ¯å‡º', 'success');
            } else {
                addLog('âŒ ç„¡æ•¸æ“šå¯åŒ¯å‡º', 'error');
            }
        }
        
        // æ¯30ç§’è‡ªå‹•æª¢æŸ¥ä¸€æ¬¡
        setInterval(() => {
            if (testInterval) {
                addLog('ğŸ”„ è‡ªå‹•æª¢æŸ¥ç‹€æ…‹...', 'info');
            }
        }, 30000);
    </script>
</body>
</html>
