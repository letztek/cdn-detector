# 任務 22.1 驗證清單：Manifest 攔截與解析模組

## 🎯 驗證目標
確認 CDN Detector 擴充功能能夠正確攔截、解析 DASH (.mpd) 和 HLS (.m3u8) manifest 檔案，並提取關鍵的串流品質資訊。

---

## ✅ 快速驗證步驟

### 🚀 **重要：請按照以下順序執行**

#### 1. 載入/重新載入擴充功能
```
1. 在 Chrome 位址列輸入：chrome://extensions/
2. 開啟「開發人員模式」（右上角開關）
3. 找到 CDN Detector，點擊「重新載入」按鈕
4. 確認沒有錯誤訊息
```

#### 2. 啟用 CDN 檢測功能 ⭐
```
1. 點擊工具列的 CDN Detector 圖示（綠色或紅色圓圈）
2. 確認開關是「開啟」狀態（綠色）
3. 如果是關閉狀態，點擊開關啟用
```

#### 3. 開啟診斷工具
```
1. 在瀏覽器中開啟：debug-manifest-detection.html
2. 按 F12 開啟 DevTools，切換到 Console 標籤
3. 清空 Console 日誌（Ctrl+L 或 Cmd+L）
```

#### 4. 執行測試
```
1. 在診斷頁面點擊「測試 DASH」按鈕
2. 等待 2-3 秒
3. 檢查 Console 是否出現：🎬 Manifest file detected
4. 重複測試 HLS
```

---

## 🔍 **預期的 Console 日誌**

### ✅ 成功的日誌應該包含：
```
🎬 Manifest file detected: https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd
✅ DASH parsing completed for tab [ID]
📊 Streaming info: 1080p, 720p, 480p, 360p, 240p
🔒 DRM Protection: Not detected
⚡ Bandwidth options: 4000000, 2000000, 1000000, 500000, 250000 bps
```

### ❌ 如果沒有看到日誌：

#### 問題 0：DOMParser 錯誤（已修復 ✅）
**症狀**：Console 出現 `DOMParser is not defined` 錯誤
**解決**：
- ✅ **已修復**：改用正則表達式解析 XML，適用於 Service Worker 環境
- 重新載入擴充功能以套用修復
- 這是 Manifest V3 Service Worker 的已知限制

#### 問題 1：CDN 檢測未啟用
**症狀**：完全沒有任何 webRequest 日誌
**解決**：
1. 點擊 CDN Detector 圖示
2. 確認開關是綠色（開啟）狀態
3. 如果不是，點擊開關啟用

#### 問題 2：擴充功能載入錯誤
**症狀**：Console 出現擴充功能錯誤
**解決**：
1. 在 `chrome://extensions/` 中檢查是否有錯誤
2. 點擊「重新載入」按鈕
3. 檢查 manifest.json 語法是否正確

#### 問題 3：權限問題
**症狀**：webRequest 無法攔截請求
**解決**：
1. 確認 manifest.json 中有 `webRequest` 權限
2. 確認 `<all_urls>` 權限存在
3. 重新載入擴充功能

---

## 📊 **詳細驗證檢查表**

### ✅ 基本功能驗證
- [ ] 擴充功能成功載入，無錯誤訊息
- [ ] CDN 檢測功能已啟用（綠色圖示）
- [ ] 診斷工具頁面正常開啟
- [ ] DevTools Console 已開啟並清空

### ✅ DASH 解析驗證
- [ ] 點擊「測試 DASH」按鈕
- [ ] Console 出現 `🎬 Manifest file detected` 訊息
- [ ] 看到 `✅ DASH parsing completed` 訊息
- [ ] 顯示串流品質資訊（解析度、頻寬）
- [ ] 顯示 DRM 保護狀態

### ✅ HLS 解析驗證
- [ ] 點擊「測試 HLS」按鈕
- [ ] Console 出現 `🎬 Manifest file detected` 訊息
- [ ] 看到 `✅ HLS parsing completed` 訊息
- [ ] 顯示串流品質資訊（解析度、頻寬）
- [ ] 顯示 DRM 保護狀態

### ✅ 資料儲存驗證
- [ ] 測試完成後，Console 顯示 `📦 Manifest data stored` 訊息
- [ ] 沒有出現儲存錯誤
- [ ] tabId 正確識別

---

## 🛠️ **進階除錯**

### 檢查 background.js 狀態
```javascript
// 在 Console 中執行這些命令來檢查狀態
chrome.runtime.getBackgroundPage((bg) => {
  console.log('CDN Detection Enabled:', bg.cdnDetectionEnabled);
  console.log('Manifest Map:', bg.manifestMap);
  console.log('Tab Detection Data:', bg.tabDetectionData);
});
```

### 檢查 webRequest 監聽器
```javascript
// 檢查是否有 webRequest 監聽器
chrome.webRequest.onCompleted.hasListeners()
```

### 手動測試 manifest 檢測函數
```javascript
// 在 Console 中測試檢測函數
const testUrl = 'https://example.com/video.mpd';
console.log('Is Manifest:', isManifestFile(testUrl));
console.log('Manifest Type:', getManifestType(testUrl));
```

---

## 📝 **驗證結果記錄**

### 成功標準：
- ✅ 至少一個 DASH manifest 成功檢測和解析
- ✅ 至少一個 HLS manifest 成功檢測和解析
- ✅ 解析結果包含串流品質資訊
- ✅ DRM 保護狀態正確識別
- ✅ 資料成功儲存到 manifestMap

### 如果仍然無法檢測：
1. 檢查 Chrome 版本是否支援 Manifest V3
2. 確認沒有其他擴充功能干擾
3. 嘗試在無痕模式下測試
4. 檢查網路連線是否正常

---

## 🎉 **驗證完成後的下一步**

任務 22.1 驗證成功後，建議：
1. 提交程式碼變更
2. 更新任務狀態為「完成」
3. 準備進行任務 22.2（媒體段監控模組）

**記住**：這個功能是影片品質監控系統的基礎，必須確保穩定運作才能繼續後續開發。 