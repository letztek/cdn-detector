<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QoE Dashboard 測試頁面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.2);
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 QoE Dashboard 測試頁面</h1>
        
        <div class="test-section">
            <h2>📊 測試項目</h2>
            <button class="test-button" onclick="testQoEDashboardAccess()">測試 QoE Dashboard 存取</button>
            <button class="test-button" onclick="testVideoMetrics()">測試影片指標收集</button>
            <button class="test-button" onclick="testBitrateFramerate()">測試位元率/幀率數據</button>
            <button class="test-button" onclick="openQoEDashboard()">開啟 QoE Dashboard</button>
            <div id="testResults" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>🎥 測試影片</h2>
            <video id="testVideo" controls>
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4">
                您的瀏覽器不支援 video 標籤。
            </video>
            <br>
            <button class="test-button" onclick="startVideoMonitoring()">開始監控影片</button>
            <button class="test-button" onclick="getVideoMetrics()">獲取影片指標</button>
        </div>
        
        <div class="test-section">
            <h2>📈 即時數據</h2>
            <div id="realTimeData" class="result">等待數據...</div>
        </div>
    </div>

    <script>
        let updateInterval;
        
        function log(message) {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function testQoEDashboardAccess() {
            log('🔍 測試 QoE Dashboard 存取...');
            
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const dashboardUrl = chrome.runtime.getURL('qoe-dashboard.html');
                    log(`✅ QoE Dashboard URL: ${dashboardUrl}`);
                    
                    // 測試檔案是否存在
                    fetch(dashboardUrl)
                        .then(response => {
                            if (response.ok) {
                                log('✅ QoE Dashboard 檔案存在且可存取');
                            } else {
                                log(`❌ QoE Dashboard 檔案存取失敗: ${response.status}`);
                            }
                        })
                        .catch(error => {
                            log(`❌ 無法存取 QoE Dashboard: ${error.message}`);
                        });
                } else {
                    log('❌ Chrome 擴充功能 API 不可用');
                }
            } catch (error) {
                log(`❌ 測試失敗: ${error.message}`);
            }
        }
        
        function testVideoMetrics() {
            log('🎥 測試影片指標收集...');
            
            const video = document.getElementById('testVideo');
            if (!video) {
                log('❌ 找不到測試影片元素');
                return;
            }
            
            // 檢查影片屬性
            log(`影片來源: ${video.currentSrc || video.src || 'N/A'}`);
            log(`影片尺寸: ${video.videoWidth}x${video.videoHeight}`);
            log(`播放狀態: ${video.paused ? '暫停' : '播放中'}`);
            log(`當前時間: ${video.currentTime.toFixed(2)}s`);
            log(`總長度: ${video.duration ? video.duration.toFixed(2) + 's' : 'N/A'}`);
            
            // 檢查播放品質 API
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                log(`播放品質支援: ✅`);
                log(`總幀數: ${quality.totalVideoFrames}`);
                log(`掉幀數: ${quality.droppedVideoFrames}`);
                log(`損壞幀數: ${quality.corruptedVideoFrames}`);
            } else {
                log('播放品質 API: ❌ 不支援');
            }
            
            // 檢查網路 API
            if (navigator.connection) {
                const conn = navigator.connection;
                log(`網路連線資訊: ✅`);
                log(`連線類型: ${conn.effectiveType}`);
                log(`下行速度: ${conn.downlink} Mbps`);
                log(`延遲: ${conn.rtt} ms`);
            } else {
                log('網路連線 API: ❌ 不支援');
            }
        }
        
        function testBitrateFramerate() {
            log('📊 測試位元率/幀率數據收集...');
            
            const video = document.getElementById('testVideo');
            if (!video) {
                log('❌ 找不到測試影片元素');
                return;
            }
            
            // 模擬位元率計算
            if (video.buffered && video.buffered.length > 0) {
                const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                const bufferedStart = video.buffered.start(0);
                const bufferedDuration = bufferedEnd - bufferedStart;
                
                log(`緩衝區間: ${bufferedStart.toFixed(2)}s - ${bufferedEnd.toFixed(2)}s`);
                log(`緩衝時長: ${bufferedDuration.toFixed(2)}s`);
                
                if (video.duration > 0) {
                    const bufferRatio = bufferedDuration / video.duration;
                    log(`緩衝比例: ${(bufferRatio * 100).toFixed(1)}%`);
                }
            } else {
                log('❌ 無緩衝區數據');
            }
            
            // 檢查 MediaSource API
            if (window.MediaSource) {
                log(`MediaSource API: ✅ 支援`);
                log(`支援的類型範例: ${MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E"')}`);
            } else {
                log('MediaSource API: ❌ 不支援');
            }
        }
        
        function startVideoMonitoring() {
            log('🚀 開始即時監控...');
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updateInterval = setInterval(() => {
                updateRealTimeData();
            }, 1000);
            
            log('✅ 即時監控已啟動 (每秒更新)');
        }
        
        function updateRealTimeData() {
            const video = document.getElementById('testVideo');
            const dataDiv = document.getElementById('realTimeData');
            
            if (!video) return;
            
            let data = `更新時間: ${new Date().toLocaleTimeString()}\n`;
            data += `播放狀態: ${video.paused ? '暫停' : '播放中'}\n`;
            data += `當前時間: ${video.currentTime.toFixed(2)}s\n`;
            data += `總長度: ${video.duration ? video.duration.toFixed(2) + 's' : 'N/A'}\n`;
            data += `影片尺寸: ${video.videoWidth}x${video.videoHeight}\n`;
            data += `音量: ${(video.volume * 100).toFixed(0)}%\n`;
            data += `播放速度: ${video.playbackRate}x\n`;
            data += `網路狀態: ${video.networkState} (${getNetworkStateText(video.networkState)})\n`;
            data += `就緒狀態: ${video.readyState} (${getReadyStateText(video.readyState)})\n`;
            
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                data += `總幀數: ${quality.totalVideoFrames}\n`;
                data += `掉幀數: ${quality.droppedVideoFrames}\n`;
                if (quality.totalVideoFrames > 0) {
                    const dropRate = (quality.droppedVideoFrames / quality.totalVideoFrames * 100).toFixed(2);
                    data += `掉幀率: ${dropRate}%\n`;
                }
            }
            
            if (navigator.connection) {
                const conn = navigator.connection;
                data += `連線類型: ${conn.effectiveType}\n`;
                data += `下行速度: ${conn.downlink} Mbps\n`;
                data += `延遲: ${conn.rtt} ms\n`;
            }
            
            dataDiv.textContent = data;
        }
        
        function getVideoMetrics() {
            log('📊 獲取完整影片指標...');
            
            // 嘗試從擴充功能獲取數據
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({ type: 'GET_VIDEO_QUALITY_DATA' }, (response) => {
                    if (chrome.runtime.lastError) {
                        log(`❌ 獲取數據失敗: ${chrome.runtime.lastError.message}`);
                        return;
                    }
                    
                    if (response && response.success) {
                        log('✅ 成功獲取影片品質數據:');
                        log(JSON.stringify(response.data, null, 2));
                    } else {
                        log('❌ 無影片品質數據');
                    }
                });
            } else {
                log('❌ 無法存取擴充功能 API');
            }
        }
        
        function openQoEDashboard() {
            log('🚀 嘗試開啟 QoE Dashboard...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    const dashboardUrl = chrome.runtime.getURL('qoe-dashboard.html');
                    window.open(dashboardUrl, '_blank', 'noopener,noreferrer');
                    log('✅ QoE Dashboard 開啟成功');
                } catch (error) {
                    log(`❌ 開啟失敗: ${error.message}`);
                }
            } else {
                log('❌ Chrome 擴充功能 API 不可用');
            }
        }
        
        function getNetworkStateText(state) {
            const states = {
                0: 'NETWORK_EMPTY',
                1: 'NETWORK_IDLE',
                2: 'NETWORK_LOADING',
                3: 'NETWORK_NO_SOURCE'
            };
            return states[state] || '未知';
        }
        
        function getReadyStateText(state) {
            const states = {
                0: 'HAVE_NOTHING',
                1: 'HAVE_METADATA',
                2: 'HAVE_CURRENT_DATA',
                3: 'HAVE_FUTURE_DATA',
                4: 'HAVE_ENOUGH_DATA'
            };
            return states[state] || '未知';
        }
        
        // 頁面載入完成後自動執行基本測試
        window.addEventListener('load', () => {
            log('🎯 QoE Dashboard 測試頁面已載入');
            log('請點擊上方按鈕開始測試各項功能');
            
            // 自動檢查基本功能
            setTimeout(() => {
                testQoEDashboardAccess();
            }, 1000);
        });
        
        // 清理
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html> 