<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QoE Dashboard æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.2);
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ QoE Dashboard æ¸¬è©¦é é¢</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š æ¸¬è©¦é …ç›®</h2>
            <button class="test-button" onclick="testQoEDashboardAccess()">æ¸¬è©¦ QoE Dashboard å­˜å–</button>
            <button class="test-button" onclick="testVideoMetrics()">æ¸¬è©¦å½±ç‰‡æŒ‡æ¨™æ”¶é›†</button>
            <button class="test-button" onclick="testBitrateFramerate()">æ¸¬è©¦ä½å…ƒç‡/å¹€ç‡æ•¸æ“š</button>
            <button class="test-button" onclick="openQoEDashboard()">é–‹å•Ÿ QoE Dashboard</button>
            <div id="testResults" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ¥ æ¸¬è©¦å½±ç‰‡</h2>
            <video id="testVideo" controls>
                <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4">
                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ video æ¨™ç±¤ã€‚
            </video>
            <br>
            <button class="test-button" onclick="startVideoMonitoring()">é–‹å§‹ç›£æ§å½±ç‰‡</button>
            <button class="test-button" onclick="getVideoMetrics()">ç²å–å½±ç‰‡æŒ‡æ¨™</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ˆ å³æ™‚æ•¸æ“š</h2>
            <div id="realTimeData" class="result">ç­‰å¾…æ•¸æ“š...</div>
        </div>
    </div>

    <script>
        let updateInterval;
        
        function log(message) {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function testQoEDashboardAccess() {
            log('ğŸ” æ¸¬è©¦ QoE Dashboard å­˜å–...');
            
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const dashboardUrl = chrome.runtime.getURL('qoe-dashboard.html');
                    log(`âœ… QoE Dashboard URL: ${dashboardUrl}`);
                    
                    // æ¸¬è©¦æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                    fetch(dashboardUrl)
                        .then(response => {
                            if (response.ok) {
                                log('âœ… QoE Dashboard æª”æ¡ˆå­˜åœ¨ä¸”å¯å­˜å–');
                            } else {
                                log(`âŒ QoE Dashboard æª”æ¡ˆå­˜å–å¤±æ•—: ${response.status}`);
                            }
                        })
                        .catch(error => {
                            log(`âŒ ç„¡æ³•å­˜å– QoE Dashboard: ${error.message}`);
                        });
                } else {
                    log('âŒ Chrome æ“´å……åŠŸèƒ½ API ä¸å¯ç”¨');
                }
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }
        
        function testVideoMetrics() {
            log('ğŸ¥ æ¸¬è©¦å½±ç‰‡æŒ‡æ¨™æ”¶é›†...');
            
            const video = document.getElementById('testVideo');
            if (!video) {
                log('âŒ æ‰¾ä¸åˆ°æ¸¬è©¦å½±ç‰‡å…ƒç´ ');
                return;
            }
            
            // æª¢æŸ¥å½±ç‰‡å±¬æ€§
            log(`å½±ç‰‡ä¾†æº: ${video.currentSrc || video.src || 'N/A'}`);
            log(`å½±ç‰‡å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}`);
            log(`æ’­æ”¾ç‹€æ…‹: ${video.paused ? 'æš«åœ' : 'æ’­æ”¾ä¸­'}`);
            log(`ç•¶å‰æ™‚é–“: ${video.currentTime.toFixed(2)}s`);
            log(`ç¸½é•·åº¦: ${video.duration ? video.duration.toFixed(2) + 's' : 'N/A'}`);
            
            // æª¢æŸ¥æ’­æ”¾å“è³ª API
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                log(`æ’­æ”¾å“è³ªæ”¯æ´: âœ…`);
                log(`ç¸½å¹€æ•¸: ${quality.totalVideoFrames}`);
                log(`æ‰å¹€æ•¸: ${quality.droppedVideoFrames}`);
                log(`æå£å¹€æ•¸: ${quality.corruptedVideoFrames}`);
            } else {
                log('æ’­æ”¾å“è³ª API: âŒ ä¸æ”¯æ´');
            }
            
            // æª¢æŸ¥ç¶²è·¯ API
            if (navigator.connection) {
                const conn = navigator.connection;
                log(`ç¶²è·¯é€£ç·šè³‡è¨Š: âœ…`);
                log(`é€£ç·šé¡å‹: ${conn.effectiveType}`);
                log(`ä¸‹è¡Œé€Ÿåº¦: ${conn.downlink} Mbps`);
                log(`å»¶é²: ${conn.rtt} ms`);
            } else {
                log('ç¶²è·¯é€£ç·š API: âŒ ä¸æ”¯æ´');
            }
        }
        
        function testBitrateFramerate() {
            log('ğŸ“Š æ¸¬è©¦ä½å…ƒç‡/å¹€ç‡æ•¸æ“šæ”¶é›†...');
            
            const video = document.getElementById('testVideo');
            if (!video) {
                log('âŒ æ‰¾ä¸åˆ°æ¸¬è©¦å½±ç‰‡å…ƒç´ ');
                return;
            }
            
            // æ¨¡æ“¬ä½å…ƒç‡è¨ˆç®—
            if (video.buffered && video.buffered.length > 0) {
                const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                const bufferedStart = video.buffered.start(0);
                const bufferedDuration = bufferedEnd - bufferedStart;
                
                log(`ç·©è¡å€é–“: ${bufferedStart.toFixed(2)}s - ${bufferedEnd.toFixed(2)}s`);
                log(`ç·©è¡æ™‚é•·: ${bufferedDuration.toFixed(2)}s`);
                
                if (video.duration > 0) {
                    const bufferRatio = bufferedDuration / video.duration;
                    log(`ç·©è¡æ¯”ä¾‹: ${(bufferRatio * 100).toFixed(1)}%`);
                }
            } else {
                log('âŒ ç„¡ç·©è¡å€æ•¸æ“š');
            }
            
            // æª¢æŸ¥ MediaSource API
            if (window.MediaSource) {
                log(`MediaSource API: âœ… æ”¯æ´`);
                log(`æ”¯æ´çš„é¡å‹ç¯„ä¾‹: ${MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E"')}`);
            } else {
                log('MediaSource API: âŒ ä¸æ”¯æ´');
            }
        }
        
        function startVideoMonitoring() {
            log('ğŸš€ é–‹å§‹å³æ™‚ç›£æ§...');
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updateInterval = setInterval(() => {
                updateRealTimeData();
            }, 1000);
            
            log('âœ… å³æ™‚ç›£æ§å·²å•Ÿå‹• (æ¯ç§’æ›´æ–°)');
        }
        
        function updateRealTimeData() {
            const video = document.getElementById('testVideo');
            const dataDiv = document.getElementById('realTimeData');
            
            if (!video) return;
            
            let data = `æ›´æ–°æ™‚é–“: ${new Date().toLocaleTimeString()}\n`;
            data += `æ’­æ”¾ç‹€æ…‹: ${video.paused ? 'æš«åœ' : 'æ’­æ”¾ä¸­'}\n`;
            data += `ç•¶å‰æ™‚é–“: ${video.currentTime.toFixed(2)}s\n`;
            data += `ç¸½é•·åº¦: ${video.duration ? video.duration.toFixed(2) + 's' : 'N/A'}\n`;
            data += `å½±ç‰‡å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}\n`;
            data += `éŸ³é‡: ${(video.volume * 100).toFixed(0)}%\n`;
            data += `æ’­æ”¾é€Ÿåº¦: ${video.playbackRate}x\n`;
            data += `ç¶²è·¯ç‹€æ…‹: ${video.networkState} (${getNetworkStateText(video.networkState)})\n`;
            data += `å°±ç·’ç‹€æ…‹: ${video.readyState} (${getReadyStateText(video.readyState)})\n`;
            
            if (video.getVideoPlaybackQuality) {
                const quality = video.getVideoPlaybackQuality();
                data += `ç¸½å¹€æ•¸: ${quality.totalVideoFrames}\n`;
                data += `æ‰å¹€æ•¸: ${quality.droppedVideoFrames}\n`;
                if (quality.totalVideoFrames > 0) {
                    const dropRate = (quality.droppedVideoFrames / quality.totalVideoFrames * 100).toFixed(2);
                    data += `æ‰å¹€ç‡: ${dropRate}%\n`;
                }
            }
            
            if (navigator.connection) {
                const conn = navigator.connection;
                data += `é€£ç·šé¡å‹: ${conn.effectiveType}\n`;
                data += `ä¸‹è¡Œé€Ÿåº¦: ${conn.downlink} Mbps\n`;
                data += `å»¶é²: ${conn.rtt} ms\n`;
            }
            
            dataDiv.textContent = data;
        }
        
        function getVideoMetrics() {
            log('ğŸ“Š ç²å–å®Œæ•´å½±ç‰‡æŒ‡æ¨™...');
            
            // å˜—è©¦å¾æ“´å……åŠŸèƒ½ç²å–æ•¸æ“š
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({ type: 'GET_VIDEO_QUALITY_DATA' }, (response) => {
                    if (chrome.runtime.lastError) {
                        log(`âŒ ç²å–æ•¸æ“šå¤±æ•—: ${chrome.runtime.lastError.message}`);
                        return;
                    }
                    
                    if (response && response.success) {
                        log('âœ… æˆåŠŸç²å–å½±ç‰‡å“è³ªæ•¸æ“š:');
                        log(JSON.stringify(response.data, null, 2));
                    } else {
                        log('âŒ ç„¡å½±ç‰‡å“è³ªæ•¸æ“š');
                    }
                });
            } else {
                log('âŒ ç„¡æ³•å­˜å–æ“´å……åŠŸèƒ½ API');
            }
        }
        
        function openQoEDashboard() {
            log('ğŸš€ å˜—è©¦é–‹å•Ÿ QoE Dashboard...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    const dashboardUrl = chrome.runtime.getURL('qoe-dashboard.html');
                    window.open(dashboardUrl, '_blank', 'noopener,noreferrer');
                    log('âœ… QoE Dashboard é–‹å•ŸæˆåŠŸ');
                } catch (error) {
                    log(`âŒ é–‹å•Ÿå¤±æ•—: ${error.message}`);
                }
            } else {
                log('âŒ Chrome æ“´å……åŠŸèƒ½ API ä¸å¯ç”¨');
            }
        }
        
        function getNetworkStateText(state) {
            const states = {
                0: 'NETWORK_EMPTY',
                1: 'NETWORK_IDLE',
                2: 'NETWORK_LOADING',
                3: 'NETWORK_NO_SOURCE'
            };
            return states[state] || 'æœªçŸ¥';
        }
        
        function getReadyStateText(state) {
            const states = {
                0: 'HAVE_NOTHING',
                1: 'HAVE_METADATA',
                2: 'HAVE_CURRENT_DATA',
                3: 'HAVE_FUTURE_DATA',
                4: 'HAVE_ENOUGH_DATA'
            };
            return states[state] || 'æœªçŸ¥';
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.addEventListener('load', () => {
            log('ğŸ¯ QoE Dashboard æ¸¬è©¦é é¢å·²è¼‰å…¥');
            log('è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦å„é …åŠŸèƒ½');
            
            // è‡ªå‹•æª¢æŸ¥åŸºæœ¬åŠŸèƒ½
            setTimeout(() => {
                testQoEDashboardAccess();
            }, 1000);
        });
        
        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html> 