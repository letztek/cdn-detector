<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–é »å“è³ªç›£æ§èª¿è©¦é é¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .debug-section {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        
        .debug-section h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 1.4em;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 10px;
        }
        
        .debug-info {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ok { background-color: #48bb78; }
        .status-error { background-color: #f56565; }
        .status-warning { background-color: #ed8936; }
        
        .button {
            background: linear-gradient(145deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .button:hover {
            background: linear-gradient(145deg, #3182ce, #2c5282);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button-danger {
            background: linear-gradient(145deg, #f56565, #e53e3e);
        }
        
        .button-danger:hover {
            background: linear-gradient(145deg, #e53e3e, #c53030);
        }
        
        .video-test {
            margin: 20px 0;
            text-align: center;
        }
        
        video {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #4299e1;
        }
        
        .log-info { background-color: #ebf8ff; border-left-color: #4299e1; }
        .log-warn { background-color: #fffbeb; border-left-color: #ed8936; }
        .log-error { background-color: #fed7d7; border-left-color: #f56565; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #3182ce);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ è¦–é »å“è³ªç›£æ§èª¿è©¦å·¥å…·</h1>
        
        <!-- ä½¿ç”¨èªªæ˜ -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; border-radius: 8px;">
            <h3 style="color: #856404; margin: 0 0 10px 0;">âš ï¸ é‡è¦ä½¿ç”¨èªªæ˜</h3>
            <p style="margin: 5px 0; color: #856404;">æ­¤èª¿è©¦é é¢å¿…é ˆåœ¨ Chrome æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­é–‹å•Ÿæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
            <p style="margin: 5px 0; color: #856404;"><strong>æ­£ç¢ºé–‹å•Ÿæ–¹å¼ï¼š</strong></p>
            <ol style="margin: 5px 0; color: #856404;">
                <li>é–‹å•Ÿ Chrome æ“´å……åŠŸèƒ½ç®¡ç†é é¢ï¼š<code>chrome://extensions/</code></li>
                <li>æ‰¾åˆ° "CDN Detector" æ“´å……åŠŸèƒ½ä¸¦è¤‡è£½å…¶ ID</li>
                <li>åœ¨ç¶²å€åˆ—è¼¸å…¥ï¼š<code>chrome-extension://[æ“´å……åŠŸèƒ½ID]/debug-video.html</code></li>
                <li>æˆ–ç›´æ¥é»æ“Šæ“´å……åŠŸèƒ½è©³æƒ…é é¢ä¸­çš„ç›¸é—œé€£çµ</li>
            </ol>
            <p style="margin: 5px 0; color: #856404;"><strong>å¦‚æœç›´æ¥é–‹å•Ÿ HTML æª”æ¡ˆå°‡ç„¡æ³•ä½¿ç”¨ Chrome æ“´å……åŠŸèƒ½ APIï¼</strong></p>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ”§ æ“´å±•ç‹€æ…‹æª¢æŸ¥</h3>
            <div class="grid">
                <div class="card">
                    <h4>åŸºæœ¬ç‹€æ…‹</h4>
                    <div id="extension-status">æª¢æŸ¥ä¸­...</div>
                    <button class="button" onclick="checkExtensionStatus()">é‡æ–°æª¢æŸ¥æ“´å±•ç‹€æ…‹</button>
                </div>
                
                <div class="card">
                    <h4>Background Script é€šä¿¡</h4>
                    <div id="background-status">æª¢æŸ¥ä¸­...</div>
                    <button class="button" onclick="testBackgroundCommunication()">æ¸¬è©¦é€šä¿¡</button>
                </div>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ¬ è¦–é »æª¢æ¸¬æ¸¬è©¦</h3>
            <div class="grid">
                <div class="card">
                    <h4>ç•¶å‰é é¢è¦–é »</h4>
                    <div id="video-detection-results">å°šæœªæª¢æ¸¬</div>
                    <button class="button" onclick="detectVideos()">é‡æ–°æª¢æ¸¬è¦–é »</button>
                </div>
                
                <div class="card">
                    <h4>Content Script ç‹€æ…‹</h4>
                    <div id="content-script-status">æª¢æŸ¥ä¸­...</div>
                    <button class="button" onclick="checkContentScript()">æª¢æŸ¥ Content Script</button>
                </div>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“Š è¦–é »å“è³ªæ•¸æ“š</h3>
            <div class="card">
                <h4>å³æ™‚æ•¸æ“š</h4>
                <div id="video-quality-data">ç„¡æ•¸æ“š</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="data-progress" style="width: 0%"></div>
                </div>
                <button class="button" onclick="refreshVideoQualityData()">åˆ·æ–°æ•¸æ“š</button>
                <button class="button button-danger" onclick="clearVideoQualityData()">æ¸…é™¤æ•¸æ“š</button>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ§ª æ¸¬è©¦è¦–é »</h3>
            <div class="video-test">
                <p>ä½¿ç”¨ä¸‹é¢çš„æ¸¬è©¦è¦–é »ä¾†é©—è­‰ç›£æ§åŠŸèƒ½ï¼š</p>
                <video controls width="600" id="test-video">
                    <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                    <source src="https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4" type="video/mp4">
                    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒè¦–é »æ¨™ç±¤ã€‚
                </video>
                <br>
                <button class="button" onclick="playTestVideo()">æ’­æ”¾æ¸¬è©¦è¦–é »</button>
                <button class="button" onclick="pauseTestVideo()">æš«åœæ¸¬è©¦è¦–é »</button>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“ å³æ™‚æ—¥èªŒ</h3>
            <div class="debug-info" id="debug-log">ç­‰å¾…æ—¥èªŒè¨Šæ¯...</div>
            <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <button class="button" onclick="exportLog()">åŒ¯å‡ºæ—¥èªŒ</button>
        </div>
        
        <div class="debug-section">
            <h3>âš™ï¸ é«˜ç´šèª¿è©¦</h3>
            <div class="grid">
                <div class="card">
                    <h4>æ‰‹å‹•æ¸¬è©¦</h4>
                    <button class="button" onclick="manualVideoScan()">æ‰‹å‹•æƒæè¦–é »</button>
                    <button class="button" onclick="testMessagePort()">æ¸¬è©¦æ¶ˆæ¯ç«¯å£</button>
                    <button class="button" onclick="simulateVideoEvent()">æ¨¡æ“¬è¦–é »äº‹ä»¶</button>
                </div>
                
                <div class="card">
                    <h4>ç³»çµ±ä¿¡æ¯</h4>
                    <div id="system-info">è¼‰å…¥ä¸­...</div>
                    <button class="button" onclick="getSystemInfo()">æ›´æ–°ç³»çµ±ä¿¡æ¯</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logEntries = [];
        let updateInterval;
        
        // æ—¥èªŒåŠŸèƒ½
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, level };
            logEntries.push(entry);
            
            const logElement = document.getElementById('debug-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            // é™åˆ¶æ—¥èªŒæ¢ç›®æ•¸é‡
            if (logEntries.length > 100) {
                logEntries = logEntries.slice(-50);
                const entries = logElement.querySelectorAll('.log-entry');
                if (entries.length > 50) {
                    for (let i = 0; i < entries.length - 50; i++) {
                        entries[i].remove();
                    }
                }
            }
        }
        
        // æª¢æŸ¥æ“´å±•ç‹€æ…‹
        async function checkExtensionStatus() {
            const statusElement = document.getElementById('extension-status');
            
            try {
                // æª¢æŸ¥ Chrome æ“´å±• API
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    statusElement.innerHTML = '<span class="status-indicator status-error"></span>âŒ Chrome æ“´å±• API ä¸å¯ç”¨';
                    addLog('Chrome extension API not available', 'error');
                    return;
                }
                
                statusElement.innerHTML = '<span class="status-indicator status-ok"></span>âœ… Chrome æ“´å±• API å¯ç”¨';
                addLog('Chrome extension API available', 'info');
                
                // æª¢æŸ¥æ“´å±• ID
                const extensionId = chrome.runtime.id;
                addLog(`Extension ID: ${extensionId}`, 'info');
                
                // æª¢æŸ¥æ¬Šé™
                if (chrome.permissions) {
                    chrome.permissions.getAll((permissions) => {
                        addLog(`Permissions: ${JSON.stringify(permissions)}`, 'info');
                    });
                }
                
            } catch (error) {
                statusElement.innerHTML = '<span class="status-indicator status-error"></span>âŒ æ“´å±•ç‹€æ…‹æª¢æŸ¥å¤±æ•—';
                addLog(`Extension status check failed: ${error.message}`, 'error');
            }
        }
        
        // æ¸¬è©¦ Background Script é€šä¿¡
        async function testBackgroundCommunication() {
            const statusElement = document.getElementById('background-status');
            
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('Not running in Chrome extension context. Please open this page via chrome-extension://[extension-id]/debug-video.html');
                }
                
                addLog('Testing background script communication...', 'info');
                
                // æ¸¬è©¦ PING
                const pingResponse = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ type: 'PING_VIDEO_QUALITY' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                if (pingResponse && pingResponse.success) {
                    statusElement.innerHTML = '<span class="status-indicator status-ok"></span>âœ… Background Script é€šä¿¡æ­£å¸¸';
                    addLog(`Background script ping successful: ${JSON.stringify(pingResponse)}`, 'info');
                } else {
                    statusElement.innerHTML = '<span class="status-indicator status-warning"></span>âš ï¸ Background Script å›æ‡‰ç•°å¸¸';
                    addLog(`Background script ping response: ${JSON.stringify(pingResponse)}`, 'warn');
                }
                
            } catch (error) {
                statusElement.innerHTML = '<span class="status-indicator status-error"></span>âŒ Background Script é€šä¿¡å¤±æ•—';
                addLog(`Background script communication failed: ${error.message}`, 'error');
                
                // å¦‚æœä¸åœ¨æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­ï¼Œæä¾›ä½¿ç”¨èªªæ˜
                if (error.message.includes('Chrome extension context')) {
                    addLog('âŒ æ­¤é é¢å¿…é ˆåœ¨ Chrome æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­é–‹å•Ÿ', 'error');
                    addLog('ğŸ“‹ ä½¿ç”¨æ–¹æ³•ï¼š', 'info');
                    addLog('1. é–‹å•Ÿ Chrome æ“´å……åŠŸèƒ½ç®¡ç†é é¢ (chrome://extensions/)', 'info');
                    addLog('2. æ‰¾åˆ° "CDN Detector" æ“´å……åŠŸèƒ½', 'info');
                    addLog('3. è¤‡è£½æ“´å……åŠŸèƒ½ ID', 'info');
                    addLog('4. åœ¨ç¶²å€åˆ—è¼¸å…¥ï¼šchrome-extension://[æ“´å……åŠŸèƒ½ID]/debug-video.html', 'info');
                    addLog('5. æˆ–è€…å°‡æ­¤æ–‡ä»¶æ‹–æ‹½åˆ°ç€è¦½å™¨çª—å£ä¸­é–‹å•Ÿ', 'info');
                }
            }
        }
        
        // æª¢æ¸¬è¦–é »å…ƒç´ 
        function detectVideos() {
            const resultsElement = document.getElementById('video-detection-results');
            
            try {
                addLog('Starting video detection...', 'info');
                
                // æª¢æ¸¬å„ç¨®è¦–é »å…ƒç´ 
                const videos = document.querySelectorAll('video');
                const objects = document.querySelectorAll('object');
                const embeds = document.querySelectorAll('embed');
                const iframes = document.querySelectorAll('iframe');
                
                let report = `æ‰¾åˆ° ${videos.length} å€‹ video å…ƒç´ \\n`;
                report += `æ‰¾åˆ° ${objects.length} å€‹ object å…ƒç´ \\n`;
                report += `æ‰¾åˆ° ${embeds.length} å€‹ embed å…ƒç´ \\n`;
                report += `æ‰¾åˆ° ${iframes.length} å€‹ iframe å…ƒç´ \\n\\n`;
                
                // è©³ç´°åˆ†æ video å…ƒç´ 
                videos.forEach((video, index) => {
                    report += `Video ${index + 1}:\\n`;
                    report += `  - src: ${video.src || video.currentSrc || 'no src'}\\n`;
                    report += `  - dimensions: ${video.videoWidth || 0}x${video.videoHeight || 0}\\n`;
                    report += `  - ready state: ${video.readyState}\\n`;
                    report += `  - network state: ${video.networkState}\\n`;
                    report += `  - paused: ${video.paused}\\n`;
                    report += `  - duration: ${video.duration || 'unknown'}\\n\\n`;
                });
                
                resultsElement.innerHTML = `<pre>${report}</pre>`;
                addLog(`Video detection completed: ${videos.length} videos found`, 'info');
                
            } catch (error) {
                resultsElement.innerHTML = `æª¢æ¸¬å¤±æ•—: ${error.message}`;
                addLog(`Video detection failed: ${error.message}`, 'error');
            }
        }
        
        // æª¢æŸ¥ Content Script
        function checkContentScript() {
            const statusElement = document.getElementById('content-script-status');
            
            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰ video-quality-monitor ç›¸é—œçš„å…¨åŸŸè®Šæ•¸æˆ–å‡½æ•¸
                const hasContentScript = window.videoQualityMonitor || 
                                        document.querySelector('script[src*=\"video-quality-monitor\"]') ||
                                        typeof window.initializeVideoMonitoring === 'function';
                
                if (hasContentScript) {
                    statusElement.innerHTML = '<span class="status-indicator status-ok"></span>âœ… Content Script å·²è¼‰å…¥';
                    addLog('Content script appears to be loaded', 'info');
                } else {
                    statusElement.innerHTML = '<span class="status-indicator status-warning"></span>âš ï¸ Content Script ç‹€æ…‹ä¸æ˜';
                    addLog('Content script status unclear', 'warn');
                }
                
                // æª¢æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ç›¸é—œæ—¥èªŒ
                addLog('Check browser console for video quality monitor logs', 'info');
                
            } catch (error) {
                statusElement.innerHTML = '<span class="status-indicator status-error"></span>âŒ Content Script æª¢æŸ¥å¤±æ•—';
                addLog(`Content script check failed: ${error.message}`, 'error');
            }
        }
        
        // åˆ·æ–°è¦–é »å“è³ªæ•¸æ“š
        async function refreshVideoQualityData() {
            const dataElement = document.getElementById('video-quality-data');
            const progressElement = document.getElementById('data-progress');
            
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('Not running in Chrome extension context');
                }
                
                addLog('Requesting video quality data...', 'info');
                progressElement.style.width = '30%';
                
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ type: 'GET_VIDEO_QUALITY_DATA' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                progressElement.style.width = '100%';
                
                if (response && response.success) {
                    const data = response.data;
                    let report = `æ´»èºæ¨™ç±¤é  ID: ${data.activeTabId || 'N/A'}\\n`;
                    report += `ç¸½æ¨™ç±¤é æ•¸: ${data.tabIds ? data.tabIds.length : 0}\\n`;
                    report += `ç•¶å‰æ¨™ç±¤é æœ‰æ•¸æ“š: ${data.currentTab ? 'æ˜¯' : 'å¦'}\\n\\n`;
                    
                    if (data.currentTab) {
                        report += `ç•¶å‰æ¨™ç±¤é æ•¸æ“š:\\n`;
                        report += `  - ç¸½è¦–é »æ•¸: ${data.currentTab.totalVideos || 0}\\n`;
                        report += `  - æ´»èºè¦–é »æ•¸: ${data.currentTab.activeVideos || 0}\\n`;
                        report += `  - æœ€å¾Œæ›´æ–°: ${new Date(data.currentTab.timestamp || Date.now()).toLocaleString()}\\n`;
                    }
                    
                    dataElement.innerHTML = `<pre>${report}</pre>`;
                    addLog('Video quality data retrieved successfully', 'info');
                } else {
                    dataElement.innerHTML = `æ•¸æ“šç²å–å¤±æ•—: ${response ? response.error : 'No response'}`;
                    addLog(`Failed to get video quality data: ${response ? response.error : 'No response'}`, 'error');
                }
                
                setTimeout(() => {
                    progressElement.style.width = '0%';
                }, 1000);
                
            } catch (error) {
                progressElement.style.width = '0%';
                dataElement.innerHTML = `éŒ¯èª¤: ${error.message}`;
                addLog(`Video quality data request failed: ${error.message}`, 'error');
            }
        }
        
        // æ¸…é™¤è¦–é »å“è³ªæ•¸æ“š
        async function clearVideoQualityData() {
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('Not running in Chrome extension context');
                }
                
                addLog('Clearing video quality data...', 'info');
                
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ type: 'CLEAR_VIDEO_QUALITY_DATA' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                if (response && response.success) {
                    addLog('Video quality data cleared successfully', 'info');
                    refreshVideoQualityData();
                } else {
                    addLog(`Failed to clear video quality data: ${response ? response.error : 'No response'}`, 'error');
                }
                
            } catch (error) {
                addLog(`Clear video quality data failed: ${error.message}`, 'error');
            }
        }
        
        // æ¸¬è©¦è¦–é »æ§åˆ¶
        function playTestVideo() {
            const video = document.getElementById('test-video');
            video.play().then(() => {
                addLog('Test video started playing', 'info');
            }).catch(error => {
                addLog(`Failed to play test video: ${error.message}`, 'error');
            });
        }
        
        function pauseTestVideo() {
            const video = document.getElementById('test-video');
            video.pause();
            addLog('Test video paused', 'info');
        }
        
        // æ‰‹å‹•è¦–é »æƒæ
        function manualVideoScan() {
            addLog('Starting manual video scan...', 'info');
            
            // æ¨¡æ“¬ content script çš„è¦–é »æª¢æ¸¬é‚è¼¯
            const allElements = document.querySelectorAll('*');
            let videoElements = [];
            
            allElements.forEach(element => {
                if (element.tagName === 'VIDEO' || 
                    element.tagName === 'OBJECT' || 
                    element.tagName === 'EMBED' ||
                    element.className.toLowerCase().includes('video') ||
                    element.id.toLowerCase().includes('video')) {
                    videoElements.push(element);
                }
            });
            
            addLog(`Manual scan found ${videoElements.length} potential video elements`, 'info');
            videoElements.forEach((element, index) => {
                addLog(`Element ${index + 1}: ${element.tagName} - class: ${element.className} - id: ${element.id}`, 'info');
            });
        }
        
        // æ¸¬è©¦æ¶ˆæ¯ç«¯å£
        function testMessagePort() {
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨æ“´å……åŠŸèƒ½ç’°å¢ƒä¸­
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('Not running in Chrome extension context');
                }
                
                addLog('Testing message port stability...', 'info');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        chrome.runtime.sendMessage({ type: 'PING_VIDEO_QUALITY' }, (response) => {
                            if (chrome.runtime.lastError) {
                                errorCount++;
                                addLog(`Message ${i + 1} failed: ${chrome.runtime.lastError.message}`, 'error');
                            } else {
                                successCount++;
                                addLog(`Message ${i + 1} succeeded`, 'info');
                            }
                            
                            if (successCount + errorCount === 5) {
                                addLog(`Message port test completed: ${successCount} success, ${errorCount} errors`, 'info');
                            }
                        });
                    }, i * 500);
                }
            } catch (error) {
                addLog(`Message port test failed: ${error.message}`, 'error');
            }
        }
        
        // æ¨¡æ“¬è¦–é »äº‹ä»¶
        function simulateVideoEvent() {
            const testVideo = document.getElementById('test-video');
            if (testVideo) {
                // è§¸ç™¼å„ç¨®è¦–é »äº‹ä»¶
                testVideo.dispatchEvent(new Event('loadstart'));
                testVideo.dispatchEvent(new Event('loadedmetadata'));
                testVideo.dispatchEvent(new Event('canplay'));
                
                addLog('Simulated video events dispatched', 'info');
            } else {
                addLog('No test video found to simulate events', 'warn');
            }
        }
        
        // ç²å–ç³»çµ±ä¿¡æ¯
        function getSystemInfo() {
            const infoElement = document.getElementById('system-info');
            
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                url: window.location.href,
                timestamp: new Date().toLocaleString()
            };
            
            let report = '';
            Object.entries(info).forEach(([key, value]) => {
                report += `${key}: ${value}\\n`;
            });
            
            infoElement.innerHTML = `<pre>${report}</pre>`;
            addLog('System information updated', 'info');
        }
        
        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            logEntries = [];
            document.getElementById('debug-log').innerHTML = 'æ—¥èªŒå·²æ¸…é™¤';
            addLog('Debug log cleared', 'info');
        }
        
        // åŒ¯å‡ºæ—¥èªŒ
        function exportLog() {
            const logText = logEntries.map(entry => 
                `[${entry.timestamp}] [${entry.level.toUpperCase()}] ${entry.message}`
            ).join('\\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video-quality-debug-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('Debug log exported', 'info');
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Debug page loaded', 'info');
            checkExtensionStatus();
            testBackgroundCommunication();
            detectVideos();
            checkContentScript();
            getSystemInfo();
            
            // è¨­ç½®è‡ªå‹•åˆ·æ–°
            updateInterval = setInterval(() => {
                refreshVideoQualityData();
            }, 10000); // æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°
        });
        
        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html> 