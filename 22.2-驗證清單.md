# Task 22.2 - Media Segment Monitoring Module 驗證清單

## 📋 功能驗證項目

### ✅ 核心功能檢測
- [ ] **媒體片段檔案檢測**
  - [ ] `.m4s` 檔案檢測（DASH 影片片段）
  - [ ] `.ts` 檔案檢測（HLS 片段）
  - [ ] `.m4a` 檔案檢測（DASH 音訊片段）
  - [ ] `.m4v` 檔案檢測（DASH 影片片段）
  - [ ] `/segment` URL 模式檢測
  - [ ] `/chunk` URL 模式檢測

### ✅ 資料收集與處理
- [ ] **片段基本資訊**
  - [ ] URL 記錄
  - [ ] 片段類型識別（DASH_VIDEO, DASH_AUDIO, HLS_SEGMENT, GENERIC_SEGMENT）
  - [ ] 時間戳記錄
  - [ ] 請求 ID 追蹤
  - [ ] HTTP 狀態碼記錄
  - [ ] 快取狀態檢測

- [ ] **大小與頻寬計算**
  - [ ] Content-Length 提取
  - [ ] 下載時間計算
  - [ ] 即時頻寬計算（bytes/second）
  - [ ] 頻寬趨勢分析

### ✅ 統計資料管理
- [ ] **基本統計**
  - [ ] 總片段數統計
  - [ ] 總下載大小統計
  - [ ] 平均頻寬計算
  - [ ] DASH vs HLS 片段分類統計

- [ ] **進階統計**
  - [ ] 失敗片段統計（HTTP 4xx/5xx）
  - [ ] 快取命中片段統計
  - [ ] 峰值頻寬記錄
  - [ ] 最低頻寬記錄
  - [ ] 近期平均頻寬（最近 10 個樣本）

### ✅ API 介面功能
- [ ] **GET_MEDIA_SEGMENT_DATA**
  - [ ] 返回片段詳細資料
  - [ ] 返回頻寬趨勢資料
  - [ ] 錯誤處理

- [ ] **GET_MEDIA_SEGMENT_STATS**
  - [ ] 全域統計資料
  - [ ] 當前標籤頁統計
  - [ ] 摘要資訊

- [ ] **CLEAR_MEDIA_SEGMENT_DATA**
  - [ ] 清除指定標籤頁資料
  - [ ] 清除頻寬趨勢資料

### ✅ 記憶體管理
- [ ] **資料限制**
  - [ ] 每個標籤頁最多保存 200 個片段記錄
  - [ ] 頻寬樣本最多保存 50 個
  - [ ] 自動清理舊資料

- [ ] **標籤頁管理**
  - [ ] 按標籤頁 ID 分組資料
  - [ ] 標籤頁關閉時資料清理

## 🧪 測試步驟

### 1. 基本連接測試
```bash
# 開啟測試頁面
open test-media-segment-monitoring.html

# 點擊「測試擴展連接」
# 預期結果：顯示 ✅ 擴展連接成功
```

### 2. 媒體片段檢測測試
```bash
# 播放 DASH 測試影片
# URL: https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd
# 預期結果：在 Console 中看到 "📺 Media segment detected" 訊息

# 播放 HLS 測試影片
# URL: https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8
# 預期結果：檢測到 .ts 片段檔案
```

### 3. 統計資料測試
```bash
# 點擊「獲取統計資料」
# 預期結果：
# - 總片段數 > 0
# - 總大小 > 0 MB
# - DASH 或 HLS 片段數 > 0
# - 統計卡片正確顯示
```

### 4. 即時頻寬監控測試
```bash
# 點擊「開始監控」
# 播放影片
# 預期結果：
# - 近期平均頻寬 > 0 KB/s
# - 峰值頻寬 > 0 KB/s
# - 頻寬數據每 2 秒更新
```

### 5. 片段詳細資料測試
```bash
# 點擊「獲取片段資料」
# 預期結果：
# - 顯示最近 20 個片段
# - 每個片段顯示類型、大小、時間、頻寬
# - 快取狀態正確顯示
```

## 🔍 除錯檢查項目

### Console 日誌檢查
```javascript
// 在瀏覽器 Console 中應該看到：
[INFO] 📺 Media segment detected: https://...
[DEBUG] Segment processed: X bytes, Yms, Z KB/s
[DEBUG] Bandwidth trend updated: Recent avg X KB/s, Peak Y KB/s
```

### 擴展 Background Script 檢查
```javascript
// 在擴展的 Service Worker Console 中檢查：
// 1. 是否有 DOMParser 錯誤（應該沒有）
// 2. 媒體片段檢測日誌
// 3. 統計更新日誌
```

### 資料結構檢查
```javascript
// 在 Console 中執行：
chrome.runtime.sendMessage({type: 'GET_MEDIA_SEGMENT_DATA'}, console.log);

// 預期返回結構：
{
  success: true,
  data: {
    segments: {
      tabId: number,
      segments: Array,
      stats: Object
    },
    bandwidth: {
      samples: Array,
      recentAverage: number,
      peakBandwidth: number,
      minBandwidth: number
    }
  }
}
```

## ⚠️ 常見問題排除

### 1. 沒有檢測到媒體片段
- **檢查**：確認擴展已重新載入
- **檢查**：確認影片正在播放
- **檢查**：檢查 Console 是否有錯誤訊息
- **解決**：嘗試不同的測試影片 URL

### 2. 頻寬計算為 0
- **原因**：缺少 Content-Length header 或下載時間
- **檢查**：查看網路請求的 Response Headers
- **解決**：使用有完整 headers 的測試影片

### 3. 統計資料不更新
- **檢查**：確認標籤頁 ID 正確
- **檢查**：確認有媒體片段被檢測到
- **解決**：重新載入頁面並重新測試

### 4. API 回應錯誤
- **檢查**：擴展是否正確安裝
- **檢查**：manifest.json 權限設定
- **解決**：重新安裝擴展

## 📊 效能指標

### 記憶體使用
- 每個片段記錄：~500 bytes
- 200 個片段：~100 KB
- 50 個頻寬樣本：~2 KB
- **總計每標籤頁**：~102 KB

### 處理效能
- 片段檢測：< 1ms
- 統計更新：< 5ms
- 頻寬計算：< 1ms

## ✅ 驗證完成標準

Task 22.2 被認為成功實現當：

1. ✅ 能正確檢測所有類型的媒體片段檔案
2. ✅ 準確計算下載時間和頻寬
3. ✅ 統計資料完整且準確
4. ✅ API 介面功能正常
5. ✅ 記憶體管理有效
6. ✅ 與 Task 22.1 無衝突
7. ✅ 測試頁面所有功能正常運作

---

**注意**：請確保在測試前已完成 Task 22.1 的實現，並且擴展已正確重新載入。 