# Task 22.2 - Media Segment Monitoring Module é©—è­‰æ¸…å–®

## ğŸ“‹ åŠŸèƒ½é©—è­‰é …ç›®

### âœ… æ ¸å¿ƒåŠŸèƒ½æª¢æ¸¬
- [ ] **åª’é«”ç‰‡æ®µæª”æ¡ˆæª¢æ¸¬**
  - [ ] `.m4s` æª”æ¡ˆæª¢æ¸¬ï¼ˆDASH å½±ç‰‡ç‰‡æ®µï¼‰
  - [ ] `.ts` æª”æ¡ˆæª¢æ¸¬ï¼ˆHLS ç‰‡æ®µï¼‰
  - [ ] `.m4a` æª”æ¡ˆæª¢æ¸¬ï¼ˆDASH éŸ³è¨Šç‰‡æ®µï¼‰
  - [ ] `.m4v` æª”æ¡ˆæª¢æ¸¬ï¼ˆDASH å½±ç‰‡ç‰‡æ®µï¼‰
  - [ ] `/segment` URL æ¨¡å¼æª¢æ¸¬
  - [ ] `/chunk` URL æ¨¡å¼æª¢æ¸¬

### âœ… è³‡æ–™æ”¶é›†èˆ‡è™•ç†
- [ ] **ç‰‡æ®µåŸºæœ¬è³‡è¨Š**
  - [ ] URL è¨˜éŒ„
  - [ ] ç‰‡æ®µé¡å‹è­˜åˆ¥ï¼ˆDASH_VIDEO, DASH_AUDIO, HLS_SEGMENT, GENERIC_SEGMENTï¼‰
  - [ ] æ™‚é–“æˆ³è¨˜éŒ„
  - [ ] è«‹æ±‚ ID è¿½è¹¤
  - [ ] HTTP ç‹€æ…‹ç¢¼è¨˜éŒ„
  - [ ] å¿«å–ç‹€æ…‹æª¢æ¸¬

- [ ] **å¤§å°èˆ‡é »å¯¬è¨ˆç®—**
  - [ ] Content-Length æå–
  - [ ] ä¸‹è¼‰æ™‚é–“è¨ˆç®—
  - [ ] å³æ™‚é »å¯¬è¨ˆç®—ï¼ˆbytes/secondï¼‰
  - [ ] é »å¯¬è¶¨å‹¢åˆ†æ

### âœ… çµ±è¨ˆè³‡æ–™ç®¡ç†
- [ ] **åŸºæœ¬çµ±è¨ˆ**
  - [ ] ç¸½ç‰‡æ®µæ•¸çµ±è¨ˆ
  - [ ] ç¸½ä¸‹è¼‰å¤§å°çµ±è¨ˆ
  - [ ] å¹³å‡é »å¯¬è¨ˆç®—
  - [ ] DASH vs HLS ç‰‡æ®µåˆ†é¡çµ±è¨ˆ

- [ ] **é€²éšçµ±è¨ˆ**
  - [ ] å¤±æ•—ç‰‡æ®µçµ±è¨ˆï¼ˆHTTP 4xx/5xxï¼‰
  - [ ] å¿«å–å‘½ä¸­ç‰‡æ®µçµ±è¨ˆ
  - [ ] å³°å€¼é »å¯¬è¨˜éŒ„
  - [ ] æœ€ä½é »å¯¬è¨˜éŒ„
  - [ ] è¿‘æœŸå¹³å‡é »å¯¬ï¼ˆæœ€è¿‘ 10 å€‹æ¨£æœ¬ï¼‰

### âœ… API ä»‹é¢åŠŸèƒ½
- [ ] **GET_MEDIA_SEGMENT_DATA**
  - [ ] è¿”å›ç‰‡æ®µè©³ç´°è³‡æ–™
  - [ ] è¿”å›é »å¯¬è¶¨å‹¢è³‡æ–™
  - [ ] éŒ¯èª¤è™•ç†

- [ ] **GET_MEDIA_SEGMENT_STATS**
  - [ ] å…¨åŸŸçµ±è¨ˆè³‡æ–™
  - [ ] ç•¶å‰æ¨™ç±¤é çµ±è¨ˆ
  - [ ] æ‘˜è¦è³‡è¨Š

- [ ] **CLEAR_MEDIA_SEGMENT_DATA**
  - [ ] æ¸…é™¤æŒ‡å®šæ¨™ç±¤é è³‡æ–™
  - [ ] æ¸…é™¤é »å¯¬è¶¨å‹¢è³‡æ–™

### âœ… è¨˜æ†¶é«”ç®¡ç†
- [ ] **è³‡æ–™é™åˆ¶**
  - [ ] æ¯å€‹æ¨™ç±¤é æœ€å¤šä¿å­˜ 200 å€‹ç‰‡æ®µè¨˜éŒ„
  - [ ] é »å¯¬æ¨£æœ¬æœ€å¤šä¿å­˜ 50 å€‹
  - [ ] è‡ªå‹•æ¸…ç†èˆŠè³‡æ–™

- [ ] **æ¨™ç±¤é ç®¡ç†**
  - [ ] æŒ‰æ¨™ç±¤é  ID åˆ†çµ„è³‡æ–™
  - [ ] æ¨™ç±¤é é—œé–‰æ™‚è³‡æ–™æ¸…ç†

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. åŸºæœ¬é€£æ¥æ¸¬è©¦
```bash
# é–‹å•Ÿæ¸¬è©¦é é¢
open test-media-segment-monitoring.html

# é»æ“Šã€Œæ¸¬è©¦æ“´å±•é€£æ¥ã€
# é æœŸçµæœï¼šé¡¯ç¤º âœ… æ“´å±•é€£æ¥æˆåŠŸ
```

### 2. åª’é«”ç‰‡æ®µæª¢æ¸¬æ¸¬è©¦
```bash
# æ’­æ”¾ DASH æ¸¬è©¦å½±ç‰‡
# URL: https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd
# é æœŸçµæœï¼šåœ¨ Console ä¸­çœ‹åˆ° "ğŸ“º Media segment detected" è¨Šæ¯

# æ’­æ”¾ HLS æ¸¬è©¦å½±ç‰‡
# URL: https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8
# é æœŸçµæœï¼šæª¢æ¸¬åˆ° .ts ç‰‡æ®µæª”æ¡ˆ
```

### 3. çµ±è¨ˆè³‡æ–™æ¸¬è©¦
```bash
# é»æ“Šã€Œç²å–çµ±è¨ˆè³‡æ–™ã€
# é æœŸçµæœï¼š
# - ç¸½ç‰‡æ®µæ•¸ > 0
# - ç¸½å¤§å° > 0 MB
# - DASH æˆ– HLS ç‰‡æ®µæ•¸ > 0
# - çµ±è¨ˆå¡ç‰‡æ­£ç¢ºé¡¯ç¤º
```

### 4. å³æ™‚é »å¯¬ç›£æ§æ¸¬è©¦
```bash
# é»æ“Šã€Œé–‹å§‹ç›£æ§ã€
# æ’­æ”¾å½±ç‰‡
# é æœŸçµæœï¼š
# - è¿‘æœŸå¹³å‡é »å¯¬ > 0 KB/s
# - å³°å€¼é »å¯¬ > 0 KB/s
# - é »å¯¬æ•¸æ“šæ¯ 2 ç§’æ›´æ–°
```

### 5. ç‰‡æ®µè©³ç´°è³‡æ–™æ¸¬è©¦
```bash
# é»æ“Šã€Œç²å–ç‰‡æ®µè³‡æ–™ã€
# é æœŸçµæœï¼š
# - é¡¯ç¤ºæœ€è¿‘ 20 å€‹ç‰‡æ®µ
# - æ¯å€‹ç‰‡æ®µé¡¯ç¤ºé¡å‹ã€å¤§å°ã€æ™‚é–“ã€é »å¯¬
# - å¿«å–ç‹€æ…‹æ­£ç¢ºé¡¯ç¤º
```

## ğŸ” é™¤éŒ¯æª¢æŸ¥é …ç›®

### Console æ—¥èªŒæª¢æŸ¥
```javascript
// åœ¨ç€è¦½å™¨ Console ä¸­æ‡‰è©²çœ‹åˆ°ï¼š
[INFO] ğŸ“º Media segment detected: https://...
[DEBUG] Segment processed: X bytes, Yms, Z KB/s
[DEBUG] Bandwidth trend updated: Recent avg X KB/s, Peak Y KB/s
```

### æ“´å±• Background Script æª¢æŸ¥
```javascript
// åœ¨æ“´å±•çš„ Service Worker Console ä¸­æª¢æŸ¥ï¼š
// 1. æ˜¯å¦æœ‰ DOMParser éŒ¯èª¤ï¼ˆæ‡‰è©²æ²’æœ‰ï¼‰
// 2. åª’é«”ç‰‡æ®µæª¢æ¸¬æ—¥èªŒ
// 3. çµ±è¨ˆæ›´æ–°æ—¥èªŒ
```

### è³‡æ–™çµæ§‹æª¢æŸ¥
```javascript
// åœ¨ Console ä¸­åŸ·è¡Œï¼š
chrome.runtime.sendMessage({type: 'GET_MEDIA_SEGMENT_DATA'}, console.log);

// é æœŸè¿”å›çµæ§‹ï¼š
{
  success: true,
  data: {
    segments: {
      tabId: number,
      segments: Array,
      stats: Object
    },
    bandwidth: {
      samples: Array,
      recentAverage: number,
      peakBandwidth: number,
      minBandwidth: number
    }
  }
}
```

## âš ï¸ å¸¸è¦‹å•é¡Œæ’é™¤

### 1. æ²’æœ‰æª¢æ¸¬åˆ°åª’é«”ç‰‡æ®µ
- **æª¢æŸ¥**ï¼šç¢ºèªæ“´å±•å·²é‡æ–°è¼‰å…¥
- **æª¢æŸ¥**ï¼šç¢ºèªå½±ç‰‡æ­£åœ¨æ’­æ”¾
- **æª¢æŸ¥**ï¼šæª¢æŸ¥ Console æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
- **è§£æ±º**ï¼šå˜—è©¦ä¸åŒçš„æ¸¬è©¦å½±ç‰‡ URL

### 2. é »å¯¬è¨ˆç®—ç‚º 0
- **åŸå› **ï¼šç¼ºå°‘ Content-Length header æˆ–ä¸‹è¼‰æ™‚é–“
- **æª¢æŸ¥**ï¼šæŸ¥çœ‹ç¶²è·¯è«‹æ±‚çš„ Response Headers
- **è§£æ±º**ï¼šä½¿ç”¨æœ‰å®Œæ•´ headers çš„æ¸¬è©¦å½±ç‰‡

### 3. çµ±è¨ˆè³‡æ–™ä¸æ›´æ–°
- **æª¢æŸ¥**ï¼šç¢ºèªæ¨™ç±¤é  ID æ­£ç¢º
- **æª¢æŸ¥**ï¼šç¢ºèªæœ‰åª’é«”ç‰‡æ®µè¢«æª¢æ¸¬åˆ°
- **è§£æ±º**ï¼šé‡æ–°è¼‰å…¥é é¢ä¸¦é‡æ–°æ¸¬è©¦

### 4. API å›æ‡‰éŒ¯èª¤
- **æª¢æŸ¥**ï¼šæ“´å±•æ˜¯å¦æ­£ç¢ºå®‰è£
- **æª¢æŸ¥**ï¼šmanifest.json æ¬Šé™è¨­å®š
- **è§£æ±º**ï¼šé‡æ–°å®‰è£æ“´å±•

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

### è¨˜æ†¶é«”ä½¿ç”¨
- æ¯å€‹ç‰‡æ®µè¨˜éŒ„ï¼š~500 bytes
- 200 å€‹ç‰‡æ®µï¼š~100 KB
- 50 å€‹é »å¯¬æ¨£æœ¬ï¼š~2 KB
- **ç¸½è¨ˆæ¯æ¨™ç±¤é **ï¼š~102 KB

### è™•ç†æ•ˆèƒ½
- ç‰‡æ®µæª¢æ¸¬ï¼š< 1ms
- çµ±è¨ˆæ›´æ–°ï¼š< 5ms
- é »å¯¬è¨ˆç®—ï¼š< 1ms

## âœ… é©—è­‰å®Œæˆæ¨™æº–

Task 22.2 è¢«èªç‚ºæˆåŠŸå¯¦ç¾ç•¶ï¼š

1. âœ… èƒ½æ­£ç¢ºæª¢æ¸¬æ‰€æœ‰é¡å‹çš„åª’é«”ç‰‡æ®µæª”æ¡ˆ
2. âœ… æº–ç¢ºè¨ˆç®—ä¸‹è¼‰æ™‚é–“å’Œé »å¯¬
3. âœ… çµ±è¨ˆè³‡æ–™å®Œæ•´ä¸”æº–ç¢º
4. âœ… API ä»‹é¢åŠŸèƒ½æ­£å¸¸
5. âœ… è¨˜æ†¶é«”ç®¡ç†æœ‰æ•ˆ
6. âœ… èˆ‡ Task 22.1 ç„¡è¡çª
7. âœ… æ¸¬è©¦é é¢æ‰€æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ

---

**æ³¨æ„**ï¼šè«‹ç¢ºä¿åœ¨æ¸¬è©¦å‰å·²å®Œæˆ Task 22.1 çš„å¯¦ç¾ï¼Œä¸¦ä¸”æ“´å±•å·²æ­£ç¢ºé‡æ–°è¼‰å…¥ã€‚ 