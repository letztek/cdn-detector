<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦éš›ç€è¦½æ¸¬è©¦ - å®‰å…¨æª¢æ¸¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        #testResults {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #666;
            margin-top: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.active {
            background-color: #28a745;
        }
        .status-indicator.inactive {
            background-color: #dc3545;
        }
        .status-indicator.warning {
            background-color: #ffc107;
        }
        .instructions {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸŒ å¯¦éš›ç€è¦½æ¸¬è©¦ - å®‰å…¨æª¢æ¸¬</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ æ¸¬è©¦èªªæ˜</h3>
            <p>é€™å€‹æ¸¬è©¦é é¢ç”¨ä¾†é©—è­‰ SecurityManager åœ¨å¯¦éš›ç€è¦½ç¶²ç«™æ™‚æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            <ol>
                <li>é¦–å…ˆé»æ“Š "æª¢æŸ¥ SecurityManager ç‹€æ…‹" ç¢ºèªæ˜¯å¦å·²åˆå§‹åŒ–</li>
                <li>å¦‚æœç‹€æ…‹æ­£å¸¸ï¼Œè«‹åœ¨æ–°æ¨™ç±¤é ä¸­è¨ªå•ä»»ä½•ç¶²ç«™ï¼ˆå¦‚ google.comï¼‰</li>
                <li>å›åˆ°é€™å€‹é é¢ï¼Œé»æ“Š "ç²å–å®‰å…¨æª¢æ¸¬æ•¸æ“š" æŸ¥çœ‹æ˜¯å¦æª¢æ¸¬åˆ°å®‰å…¨æ¨™é ­</li>
                <li>å¦‚æœä»æœ‰å•é¡Œï¼Œé»æ“Š "å¼·åˆ¶é‡æ–°åˆå§‹åŒ–" å˜—è©¦ä¿®å¾©</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h2>åŸºæœ¬ç‹€æ…‹æª¢æŸ¥</h2>
            <button class="test-button" id="checkStatus">ğŸ” æª¢æŸ¥ SecurityManager ç‹€æ…‹</button>
            <button class="test-button" id="forceInit">ğŸ”„ å¼·åˆ¶é‡æ–°åˆå§‹åŒ–</button>
            <button class="test-button" id="clearResults">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
        </div>
        
        <div class="test-section">
            <h2>å®‰å…¨æª¢æ¸¬æ¸¬è©¦</h2>
            <button class="test-button" id="getCurrentTabSecurity">ğŸ›¡ï¸ ç²å–ç•¶å‰æ¨™ç±¤é å®‰å…¨æ•¸æ“š</button>
            <button class="test-button" id="getAllTabsSecurity">ğŸ“Š ç²å–æ‰€æœ‰æ¨™ç±¤é å®‰å…¨æ•¸æ“š</button>
        </div>
        
        <div class="test-section">
            <h2>èª¿è©¦è³‡è¨Š</h2>
            <button class="test-button" id="getDebugLogs">ğŸ“ ç²å–èª¿è©¦æ—¥èªŒ</button>
            <button class="test-button" id="getExtensionInfo">â„¹ï¸ ç²å–æ“´å±•ä¿¡æ¯</button>
        </div>
        
        <div id="testResults"></div>
    </div>

    <script>
        let testResults = document.getElementById('testResults');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `test-result ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            testResults.appendChild(logEntry);
            console.log(`[${timestamp}] ${message}`);
            
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        function clearResults() {
            testResults.innerHTML = '';
        }
        
        function formatJSON(obj) {
            return `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
        }
        
        // æª¢æŸ¥ SecurityManager ç‹€æ…‹
        document.getElementById('checkStatus').addEventListener('click', async () => {
            log('ğŸ” é–‹å§‹æª¢æŸ¥ SecurityManager ç‹€æ…‹...', 'info');
            
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_SECURITY_STATUS' });
                
                if (response && response.success) {
                    const status = response.status;
                    
                    if (status.enabled) {
                        log(`âœ… SecurityManager å·²å•Ÿç”¨ä¸¦æ­£å¸¸é‹è¡Œ`, 'success');
                        log(`ç‹€æ…‹è©³æƒ…: ${formatJSON(status)}`, 'info');
                    } else {
                        log(`âš ï¸ SecurityManager æœªå•Ÿç”¨`, 'warning');
                        log(`éŒ¯èª¤ä¿¡æ¯: ${status.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'warning');
                        log(`ç‹€æ…‹è©³æƒ…: ${formatJSON(status)}`, 'info');
                    }
                } else {
                    log(`âŒ ç„¡æ³•ç²å– SecurityManager ç‹€æ…‹`, 'error');
                    log(`éŒ¯èª¤: ${response?.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                log(`âŒ æª¢æŸ¥ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // å¼·åˆ¶é‡æ–°åˆå§‹åŒ–
        document.getElementById('forceInit').addEventListener('click', async () => {
            log('ğŸ”„ å˜—è©¦å¼·åˆ¶é‡æ–°åˆå§‹åŒ– SecurityManager...', 'info');
            
            try {
                // å…ˆå˜—è©¦ç²å–ç‹€æ…‹è§¸ç™¼åˆå§‹åŒ–
                const statusResponse = await chrome.runtime.sendMessage({ type: 'GET_SECURITY_STATUS' });
                
                // ç­‰å¾…ä¸€ç§’
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // å†æ¬¡æª¢æŸ¥ç‹€æ…‹
                const statusResponse2 = await chrome.runtime.sendMessage({ type: 'GET_SECURITY_STATUS' });
                
                if (statusResponse2?.success && statusResponse2.status?.enabled) {
                    log(`âœ… é‡æ–°åˆå§‹åŒ–æˆåŠŸï¼SecurityManager ç¾åœ¨æ­£å¸¸é‹è¡Œ`, 'success');
                } else {
                    log(`âš ï¸ é‡æ–°åˆå§‹åŒ–å¯èƒ½å¤±æ•—`, 'warning');
                    log(`ç•¶å‰ç‹€æ…‹: ${statusResponse2?.status?.error || 'æœªçŸ¥'}`, 'warning');
                }
            } catch (error) {
                log(`âŒ é‡æ–°åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // ç²å–ç•¶å‰æ¨™ç±¤é å®‰å…¨æ•¸æ“š
        document.getElementById('getCurrentTabSecurity').addEventListener('click', async () => {
            log('ğŸ›¡ï¸ æ­£åœ¨ç²å–ç•¶å‰æ¨™ç±¤é å®‰å…¨æª¢æ¸¬æ•¸æ“š...', 'info');
            
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_SECURITY_DATA' });
                
                if (response && response.success) {
                    log(`âœ… æˆåŠŸç²å–å®‰å…¨æª¢æ¸¬æ•¸æ“š`, 'success');
                    log(`æ•¸æ“šå…§å®¹: ${formatJSON(response.data)}`, 'info');
                    
                    // åˆ†ææ•¸æ“š
                    const data = response.data;
                    if (data && data.headers) {
                        let foundHeaders = 0;
                        if (data.headers.csp) foundHeaders++;
                        if (data.headers.frameProtection) foundHeaders++;
                        
                        if (foundHeaders > 0) {
                            log(`ğŸ‰ æª¢æ¸¬åˆ° ${foundHeaders} ç¨®å®‰å…¨æ¨™é ­`, 'success');
                        } else {
                            log(`â„¹ï¸ ç•¶å‰ç¶²ç«™æœªæª¢æ¸¬åˆ°å®‰å…¨æ¨™é ­`, 'info');
                        }
                    } else {
                        log(`â„¹ï¸ æš«ç„¡å®‰å…¨æª¢æ¸¬æ•¸æ“šï¼ˆå¯èƒ½éœ€è¦ç€è¦½ç¶²ç«™å¾Œé‡è©¦ï¼‰`, 'info');
                    }
                } else {
                    log(`âš ï¸ ç„¡æ³•ç²å–å®‰å…¨æª¢æ¸¬æ•¸æ“š`, 'warning');
                    log(`éŒ¯èª¤: ${response?.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'warning');
                }
            } catch (error) {
                log(`âŒ ç²å–å®‰å…¨æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // ç²å–æ‰€æœ‰æ¨™ç±¤é å®‰å…¨æ•¸æ“š
        document.getElementById('getAllTabsSecurity').addEventListener('click', async () => {
            log('ğŸ“Š æ­£åœ¨ç²å–æ‰€æœ‰æ¨™ç±¤é çš„å®‰å…¨æª¢æ¸¬çµ±è¨ˆ...', 'info');
            
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_SECURITY_STATS' });
                
                if (response && response.success) {
                    log(`âœ… æˆåŠŸç²å–å®‰å…¨æª¢æ¸¬çµ±è¨ˆ`, 'success');
                    log(`çµ±è¨ˆæ•¸æ“š: ${formatJSON(response.stats)}`, 'info');
                } else {
                    log(`âš ï¸ ç„¡æ³•ç²å–å®‰å…¨æª¢æ¸¬çµ±è¨ˆ`, 'warning');
                    log(`éŒ¯èª¤: ${response?.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'warning');
                }
            } catch (error) {
                log(`âŒ ç²å–çµ±è¨ˆæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // ç²å–èª¿è©¦æ—¥èªŒ
        document.getElementById('getDebugLogs').addEventListener('click', async () => {
            log('ğŸ“ æ­£åœ¨ç²å–èª¿è©¦æ—¥èªŒ...', 'info');
            
            try {
                const result = await chrome.storage.local.get(['debugLogs']);
                const logs = result.debugLogs || [];
                
                log(`âœ… ç²å–åˆ° ${logs.length} æ¢èª¿è©¦æ—¥èªŒ`, 'success');
                
                if (logs.length > 0) {
                    // é¡¯ç¤ºæœ€è¿‘ 10 æ¢æ—¥èªŒ
                    const recentLogs = logs.slice(-10);
                    log(`æœ€è¿‘ 10 æ¢æ—¥èªŒ: ${formatJSON(recentLogs)}`, 'info');
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ SecurityManager ç›¸é—œæ—¥èªŒ
                    const securityLogs = logs.filter(log => log.includes('Security'));
                    if (securityLogs.length > 0) {
                        log(`æ‰¾åˆ° ${securityLogs.length} æ¢å®‰å…¨ç›¸é—œæ—¥èªŒ`, 'info');
                        log(`å®‰å…¨æ—¥èªŒæ¨£æœ¬: ${formatJSON(securityLogs.slice(-5))}`, 'info');
                    }
                } else {
                    log(`â„¹ï¸ æš«ç„¡èª¿è©¦æ—¥èªŒ`, 'info');
                }
            } catch (error) {
                log(`âŒ ç²å–èª¿è©¦æ—¥èªŒæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // ç²å–æ“´å±•ä¿¡æ¯
        document.getElementById('getExtensionInfo').addEventListener('click', async () => {
            log('â„¹ï¸ æ­£åœ¨ç²å–æ“´å±•åŸºæœ¬ä¿¡æ¯...', 'info');
            
            try {
                const manifest = chrome.runtime.getManifest();
                log(`æ“´å±•åç¨±: ${manifest.name}`, 'info');
                log(`ç‰ˆæœ¬: ${manifest.version}`, 'info');
                log(`Manifest ç‰ˆæœ¬: ${manifest.manifest_version}`, 'info');
                
                // æª¢æŸ¥æ¬Šé™
                const permissions = manifest.permissions || [];
                log(`æ¬Šé™: ${permissions.join(', ')}`, 'info');
                
                // æª¢æŸ¥ web_accessible_resources
                const webResources = manifest.web_accessible_resources || [];
                if (webResources.length > 0 && webResources[0].resources) {
                    const securityResources = webResources[0].resources.filter(r => r.includes('security'));
                    log(`å®‰å…¨ç›¸é—œè³‡æº: ${securityResources.join(', ')}`, 'info');
                }
                
                log(`âœ… æ“´å±•ä¿¡æ¯ç²å–å®Œæˆ`, 'success');
            } catch (error) {
                log(`âŒ ç²å–æ“´å±•ä¿¡æ¯æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        });
        
        // æ¸…é™¤çµæœ
        document.getElementById('clearResults').addEventListener('click', clearResults);
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸŒ å¯¦éš›ç€è¦½æ¸¬è©¦é é¢å·²è¼‰å…¥', 'info');
            log('è«‹æŒ‰ç…§èªªæ˜é€²è¡Œæ¸¬è©¦ï¼Œé©—è­‰ SecurityManager æ˜¯å¦æ­£å¸¸å·¥ä½œ', 'info');
        });
    </script>
</body>
</html>