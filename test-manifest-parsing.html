<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifest è§£æåŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        h1 { color: #333; }
        h2 { color: #667eea; }
        .status { 
            display: inline-block; 
            padding: 2px 8px; 
            border-radius: 3px; 
            font-size: 12px; 
            font-weight: bold;
        }
        .status.detected { background: #28a745; color: white; }
        .status.not-detected { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Manifest è§£æåŠŸèƒ½æ¸¬è©¦</h1>
        <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦ CDN Detector æ“´å……åŠŸèƒ½çš„ Manifest æ””æˆªèˆ‡è§£æåŠŸèƒ½ã€‚</p>
    </div>

    <div class="container">
        <div class="test-section">
            <h2>1. æ“´å……åŠŸèƒ½ç‹€æ…‹æª¢æŸ¥</h2>
            <button class="test-button" onclick="checkExtensionStatus()">æª¢æŸ¥æ“´å……åŠŸèƒ½</button>
            <div id="extension-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. Manifest çµ±è¨ˆè³‡è¨Š</h2>
            <button class="test-button" onclick="getManifestStats()">ç²å–çµ±è¨ˆè³‡è¨Š</button>
            <div id="stats-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. æ¸¬è©¦ DASH Manifest (.mpd)</h2>
            <p>è¼‰å…¥ä¸€å€‹ç¯„ä¾‹ DASH manifest æª”æ¡ˆä¾†æ¸¬è©¦è§£æåŠŸèƒ½ï¼š</p>
            <button class="test-button" onclick="testDashManifest()">æ¸¬è©¦ DASH è§£æ</button>
            <div id="dash-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. æ¸¬è©¦ HLS Manifest (.m3u8)</h2>
            <p>è¼‰å…¥ä¸€å€‹ç¯„ä¾‹ HLS manifest æª”æ¡ˆä¾†æ¸¬è©¦è§£æåŠŸèƒ½ï¼š</p>
            <button class="test-button" onclick="testHlsManifest()">æ¸¬è©¦ HLS è§£æ</button>
            <div id="hls-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. æ¸…é™¤ Manifest è³‡æ–™</h2>
            <button class="test-button" onclick="clearManifestData()">æ¸…é™¤è³‡æ–™</button>
            <div id="clear-result" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æ¸¬è©¦æŒ‡å—</h2>
        <ol>
            <li><strong>å®‰è£æ“´å……åŠŸèƒ½</strong>ï¼šç¢ºä¿ CDN Detector æ“´å……åŠŸèƒ½å·²åœ¨ Chrome ä¸­è¼‰å…¥</li>
            <li><strong>æª¢æŸ¥ç‹€æ…‹</strong>ï¼šé»æ“Šã€Œæª¢æŸ¥æ“´å……åŠŸèƒ½ã€ç¢ºèªé€šè¨Šæ­£å¸¸</li>
            <li><strong>æ¸¬è©¦è§£æ</strong>ï¼šé»æ“Šæ¸¬è©¦æŒ‰éˆ•è¼‰å…¥ç¯„ä¾‹ manifest æª”æ¡ˆ</li>
            <li><strong>æŸ¥çœ‹çµæœ</strong>ï¼šåœ¨çµæœå€åŸŸæŸ¥çœ‹è§£æçš„è©³ç´°è³‡è¨Š</li>
            <li><strong>æª¢æŸ¥æ—¥èªŒ</strong>ï¼šé–‹å•Ÿ Chrome DevTools Console æŸ¥çœ‹è©³ç´°æ—¥èªŒ</li>
        </ol>
        
        <h3>ğŸ” å¦‚ä½•æŸ¥çœ‹è©³ç´°æ—¥èªŒï¼š</h3>
        <ol>
            <li>æŒ‰ F12 æˆ–å³éµé¸æ“‡ã€Œæª¢æŸ¥ã€é–‹å•Ÿ DevTools</li>
            <li>åˆ‡æ›åˆ°ã€ŒConsoleã€æ¨™ç±¤</li>
            <li>å°‹æ‰¾ä»¥ "ğŸ¬ Manifest file detected" é–‹é ­çš„æ—¥èªŒ</li>
            <li>æŸ¥çœ‹ manifest è§£æçš„è©³ç´°éç¨‹</li>
        </ol>
    </div>

    <script>
        // æª¢æŸ¥æ“´å……åŠŸèƒ½ç‹€æ…‹
        async function checkExtensionStatus() {
            const resultDiv = document.getElementById('extension-result');
            resultDiv.textContent = 'æª¢æŸ¥ä¸­...';
            
            try {
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('Chrome æ“´å……åŠŸèƒ½ API ä¸å¯ç”¨');
                }
                
                const response = await sendMessage({ type: 'GET_DETECTION_STATUS' });
                
                if (response.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æ“´å……åŠŸèƒ½æ­£å¸¸é‹ä½œ
ç‹€æ…‹ï¼š${response.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}
æª¢æ¸¬ä¸­çš„æ¨™ç±¤é ï¼š${response.tabCount || 0} å€‹
æ™‚é–“æˆ³ï¼š${new Date(response.timestamp).toLocaleString()}`;
                } else {
                    throw new Error(response.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ éŒ¯èª¤ï¼š${error.message}
                
è«‹ç¢ºèªï¼š
1. CDN Detector æ“´å……åŠŸèƒ½å·²å®‰è£ä¸¦å•Ÿç”¨
2. æ­¤é é¢å¯ä»¥èˆ‡æ“´å……åŠŸèƒ½é€šè¨Š
3. æª¢æŸ¥ Chrome æ“´å……åŠŸèƒ½æ¬Šé™è¨­å®š`;
            }
        }

        // ç²å– Manifest çµ±è¨ˆè³‡è¨Š
        async function getManifestStats() {
            const resultDiv = document.getElementById('stats-result');
            resultDiv.textContent = 'ç²å–çµ±è¨ˆè³‡è¨Šä¸­...';
            
            try {
                const response = await sendMessage({ type: 'GET_MANIFEST_STATS' });
                
                if (response.success) {
                    const stats = response.stats;
                    resultDiv.className = 'result info';
                    resultDiv.textContent = `ğŸ“Š Manifest çµ±è¨ˆè³‡è¨Šï¼š

ç¸½æ¨™ç±¤é æ•¸ï¼š${stats.totalTabs}
ç›®å‰æ¨™ç±¤é  IDï¼š${stats.activeTabId}
ç¸½ Manifest æ•¸ï¼š${stats.summary.totalManifests}
DASH æª”æ¡ˆï¼š${stats.summary.dashCount}
HLS æª”æ¡ˆï¼š${stats.summary.hlsCount}
DRM ä¿è­·ï¼š${stats.summary.drmCount}
æ›´æ–°æ™‚é–“ï¼š${new Date(stats.timestamp).toLocaleString()}

${stats.activeTabData ? 
    `ç›®å‰æ¨™ç±¤é è³‡æ–™ï¼š
- Manifest æ•¸é‡ï¼š${Object.keys(stats.activeTabData.manifests).length}
- æœ€å¾Œæ›´æ–°ï¼š${new Date(stats.activeTabData.lastUpdated).toLocaleString()}` 
    : 'ç›®å‰æ¨™ç±¤é ç„¡ Manifest è³‡æ–™'}`;
                } else {
                    throw new Error(response.error || 'ç²å–çµ±è¨ˆè³‡è¨Šå¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ éŒ¯èª¤ï¼š${error.message}`;
            }
        }

        // æ¸¬è©¦ DASH Manifest
        async function testDashManifest() {
            const resultDiv = document.getElementById('dash-result');
            resultDiv.textContent = 'è¼‰å…¥ DASH manifest æ¸¬è©¦ä¸­...';
            
            try {
                // å‰µå»ºä¸€å€‹ç¯„ä¾‹ DASH manifest URLï¼ˆå¯¦éš›ä¸Šæœƒè§¸ç™¼æ“´å……åŠŸèƒ½çš„æ””æˆªï¼‰
                const testUrl = 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd';
                
                // å˜—è©¦è¼‰å…¥ manifestï¼ˆé€™æœƒè§¸ç™¼ webRequest ç›£è½å™¨ï¼‰
                const response = await fetch(testUrl, { method: 'HEAD' });
                
                resultDiv.className = 'result info';
                resultDiv.textContent = `ğŸ¯ DASH Manifest æ¸¬è©¦ï¼š

æ¸¬è©¦ URLï¼š${testUrl}
HTTP ç‹€æ…‹ï¼š${response.status} ${response.statusText}
Content-Typeï¼š${response.headers.get('content-type') || 'N/A'}

â³ è«‹ç­‰å¾… 2-3 ç§’ï¼Œç„¶å¾Œé»æ“Šã€Œç²å–çµ±è¨ˆè³‡è¨Šã€æŸ¥çœ‹è§£æçµæœ
ğŸ’¡ åŒæ™‚æª¢æŸ¥ Chrome Console æŸ¥çœ‹è©³ç´°çš„è§£ææ—¥èªŒ`;

                // ç­‰å¾…ä¸€ä¸‹è®“æ“´å……åŠŸèƒ½è™•ç†
                setTimeout(() => {
                    resultDiv.textContent += '\n\nâœ… æ¸¬è©¦å®Œæˆï¼Œè«‹é»æ“Šã€Œç²å–çµ±è¨ˆè³‡è¨Šã€æŸ¥çœ‹çµæœ';
                }, 2000);
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ DASH æ¸¬è©¦éŒ¯èª¤ï¼š${error.message}
                
é€™å¯èƒ½æ˜¯å› ç‚ºï¼š
1. ç¶²è·¯é€£ç·šå•é¡Œ
2. CORS æ”¿ç­–é™åˆ¶
3. æ¸¬è©¦ URL ä¸å¯ç”¨

è«‹æª¢æŸ¥ Chrome Console æŸ¥çœ‹æ“´å……åŠŸèƒ½æ˜¯å¦æª¢æ¸¬åˆ° manifest æª”æ¡ˆ`;
            }
        }

        // æ¸¬è©¦ HLS Manifest
        async function testHlsManifest() {
            const resultDiv = document.getElementById('hls-result');
            resultDiv.textContent = 'è¼‰å…¥ HLS manifest æ¸¬è©¦ä¸­...';
            
            try {
                // å‰µå»ºä¸€å€‹ç¯„ä¾‹ HLS manifest URL
                const testUrl = 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8';
                
                // å˜—è©¦è¼‰å…¥ manifest
                const response = await fetch(testUrl, { method: 'HEAD' });
                
                resultDiv.className = 'result info';
                resultDiv.textContent = `ğŸ¯ HLS Manifest æ¸¬è©¦ï¼š

æ¸¬è©¦ URLï¼š${testUrl}
HTTP ç‹€æ…‹ï¼š${response.status} ${response.statusText}
Content-Typeï¼š${response.headers.get('content-type') || 'N/A'}

â³ è«‹ç­‰å¾… 2-3 ç§’ï¼Œç„¶å¾Œé»æ“Šã€Œç²å–çµ±è¨ˆè³‡è¨Šã€æŸ¥çœ‹è§£æçµæœ
ğŸ’¡ åŒæ™‚æª¢æŸ¥ Chrome Console æŸ¥çœ‹è©³ç´°çš„è§£ææ—¥èªŒ`;

                setTimeout(() => {
                    resultDiv.textContent += '\n\nâœ… æ¸¬è©¦å®Œæˆï¼Œè«‹é»æ“Šã€Œç²å–çµ±è¨ˆè³‡è¨Šã€æŸ¥çœ‹çµæœ';
                }, 2000);
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ HLS æ¸¬è©¦éŒ¯èª¤ï¼š${error.message}
                
é€™å¯èƒ½æ˜¯å› ç‚ºï¼š
1. ç¶²è·¯é€£ç·šå•é¡Œ
2. CORS æ”¿ç­–é™åˆ¶  
3. æ¸¬è©¦ URL ä¸å¯ç”¨

è«‹æª¢æŸ¥ Chrome Console æŸ¥çœ‹æ“´å……åŠŸèƒ½æ˜¯å¦æª¢æ¸¬åˆ° manifest æª”æ¡ˆ`;
            }
        }

        // æ¸…é™¤ Manifest è³‡æ–™
        async function clearManifestData() {
            const resultDiv = document.getElementById('clear-result');
            resultDiv.textContent = 'æ¸…é™¤è³‡æ–™ä¸­...';
            
            try {
                const response = await sendMessage({ type: 'CLEAR_MANIFEST_DATA' });
                
                if (response.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… Manifest è³‡æ–™å·²æ¸…é™¤';
                } else {
                    throw new Error(response.error || 'æ¸…é™¤å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ æ¸…é™¤éŒ¯èª¤ï¼š${error.message}`;
            }
        }

        // æ“´å……åŠŸèƒ½ IDï¼ˆéœ€è¦å‹•æ…‹ç²å–ï¼‰
        let extensionId = null;
        
        // ç™¼é€è¨Šæ¯åˆ°æ“´å……åŠŸèƒ½
        function sendMessage(message) {
            return new Promise((resolve, reject) => {
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    reject(new Error('Chrome runtime API ä¸å¯ç”¨'));
                    return;
                }
                
                // å¦‚æœæ²’æœ‰æ“´å……åŠŸèƒ½ IDï¼Œå˜—è©¦ç²å–
                if (!extensionId) {
                    // å˜—è©¦å¾å·²çŸ¥çš„æ–¹å¼ç²å– ID
                    tryGetExtensionId().then(id => {
                        if (id) {
                            extensionId = id;
                            sendMessageWithId(message, resolve, reject);
                        } else {
                            reject(new Error('ç„¡æ³•ç²å–æ“´å……åŠŸèƒ½ IDã€‚è«‹ç¢ºèª CDN Detector å·²å®‰è£ä¸¦å•Ÿç”¨ã€‚'));
                        }
                    }).catch(error => {
                        reject(new Error('ç²å–æ“´å……åŠŸèƒ½ ID å¤±æ•—ï¼š' + error.message));
                    });
                } else {
                    sendMessageWithId(message, resolve, reject);
                }
            });
        }
        
        function sendMessageWithId(message, resolve, reject) {
            chrome.runtime.sendMessage(extensionId, message, (response) => {
                if (chrome.runtime.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                } else {
                    resolve(response || {});
                }
            });
        }
        
        // å˜—è©¦ç²å–æ“´å……åŠŸèƒ½ ID
        async function tryGetExtensionId() {
            try {
                // æ–¹æ³•1ï¼šå˜—è©¦é€šé chrome.management API
                if (chrome.management) {
                    const extensions = await new Promise((resolve) => {
                        chrome.management.getAll(resolve);
                    });
                    const cdnDetector = extensions.find(ext => 
                        ext.name.includes('CDN Detector') && ext.enabled
                    );
                    if (cdnDetector) {
                        return cdnDetector.id;
                    }
                }
                
                // æ–¹æ³•2ï¼šå˜—è©¦ä¸€äº›å¸¸è¦‹çš„é–‹ç™¼æ¨¡å¼ ID
                const commonDevIds = [
                    'aeoldapcjkjnpkmcjlgfpbfbcjdlcidc', // å¸¸è¦‹çš„é–‹ç™¼æ¨¡å¼ ID
                    'kmendfapggjehodndflmmgagdbamhnfd',
                    'fmkadmapgofadopljbjfkapdkoienihi'
                ];
                
                for (const id of commonDevIds) {
                    try {
                        await new Promise((resolve, reject) => {
                            chrome.runtime.sendMessage(id, {type: 'PING'}, (response) => {
                                if (chrome.runtime.lastError) {
                                    reject(new Error(chrome.runtime.lastError.message));
                                } else {
                                    resolve(response);
                                }
                            });
                        });
                        return id; // å¦‚æœæˆåŠŸï¼Œè¿”å›é€™å€‹ ID
                    } catch (e) {
                        // ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹
                    }
                }
                
                return null;
            } catch (error) {
                console.error('ç²å–æ“´å……åŠŸèƒ½ ID æ™‚å‡ºéŒ¯:', error);
                return null;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç‹€æ…‹
        window.addEventListener('load', () => {
            console.log('ğŸ¬ Manifest æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('è«‹ç¢ºä¿ CDN Detector æ“´å……åŠŸèƒ½å·²å®‰è£ä¸¦å•Ÿç”¨');
            
            // è‡ªå‹•æª¢æŸ¥æ“´å……åŠŸèƒ½ç‹€æ…‹
            setTimeout(checkExtensionStatus, 1000);
        });
    </script>
</body>
</html> 